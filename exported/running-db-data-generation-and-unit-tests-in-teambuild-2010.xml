<?xml version="1.0" encoding="utf-8"?>
<post>
  <id>85ea1e67-05c2-4a2a-be40-e21b26b9ae6a</id>
  <title>Running DB Data Generation and Unit Tests in TeamBuild 2010</title>
  <slug>running-db-data-generation-and-unit-tests-in-teambuild-2010</slug>
  <shortUrl>http://bit.ly/1meAXHt</shortUrl>
  <author>Colin Dembovsky</author>
  <pubDate>2010-10-13 16:38:00</pubDate>
  <lastModified>2020-04-08 03:02:09</lastModified>
  <content>&lt;p&gt;Using “Data Dude” (or VS DB Professional) in VS 2010 allows you to bring Agile to your database development. You can import a database schema and add it to source control – so you get linking to work items as well as branching and labelling etc. Furthermore, you can use TeamBuild to build a .schema file, and then use vsdbcmd.exe to deploy schema changes (incrementally) to databases. You can also create unit tests and data generation plans.&lt;/p&gt;&lt;p&gt;Importing the schema and building the schema in TeamBuild is straightforward. However, if you want to add running data generation and unit tests in your build, you have to jump through a few hoops.&lt;/p&gt;&lt;p&gt;Let’s go through an example. &lt;/p&gt;&lt;p&gt;First, we’ll import the schema into a database project using the SQL 2008 Database Wizard project template.&lt;/p&gt;&lt;p&gt;&lt;a href="http://lh4.ggpht.com/_d41Ixos7YsM/TLXD8GfKUPI/AAAAAAAAALU/9AjFDPLyJ9s/s1600-h/schemaexplorer3.png"&gt;&lt;img style="BORDER-RIGHT-WIDTH: 0px; DISPLAY: inline; BORDER-TOP-WIDTH: 0px; BORDER-BOTTOM-WIDTH: 0px; BORDER-LEFT-WIDTH: 0px" title="Schema explorer" border="0" alt="Schema explorer" src="http://lh5.ggpht.com/_d41Ixos7YsM/TLXD9-ToJVI/AAAAAAAAALY/EaEyRWt3-OQ/schemaexplorer_thumb1.png?imgmax=800" width="219" height="484" /&gt;&lt;/a&gt; &lt;/p&gt;&lt;p&gt;Next, right click the Data Generation Plans folder and add a new Data Generation plan. The details are not important for this example, so just accept the defaults. Press F5 to generate data to the database.&lt;/p&gt;&lt;p&gt;&lt;a href="http://lh6.ggpht.com/_d41Ixos7YsM/TLXEANaMFqI/AAAAAAAAALc/g-08J70UYqk/s1600-h/datageneration3.png"&gt;&lt;img style="BORDER-RIGHT-WIDTH: 0px; DISPLAY: inline; BORDER-TOP-WIDTH: 0px; BORDER-BOTTOM-WIDTH: 0px; BORDER-LEFT-WIDTH: 0px" title="Data generation plan" border="0" alt="Data generation plan" src="http://lh5.ggpht.com/_d41Ixos7YsM/TLXECothJbI/AAAAAAAAALg/dU8o_Ny0K34/datageneration_thumb1.png?imgmax=800" width="551" height="484" /&gt;&lt;/a&gt; &lt;/p&gt;&lt;p&gt;Now go to the schema view and select a stored proc. Right click and select “Create Unit Tests”.&lt;/p&gt;&lt;p&gt;&lt;a href="http://lh6.ggpht.com/_d41Ixos7YsM/TLXEFMowDMI/AAAAAAAAALk/xKzkmQrIlOI/s1600-h/testSettings3.png"&gt;&lt;img style="BORDER-RIGHT-WIDTH: 0px; DISPLAY: inline; BORDER-TOP-WIDTH: 0px; BORDER-BOTTOM-WIDTH: 0px; BORDER-LEFT-WIDTH: 0px" title="Unit test settings" border="0" alt="Unit test settings" src="http://lh5.ggpht.com/_d41Ixos7YsM/TLXEHr_9qzI/AAAAAAAAALo/dC0LIUmUOxk/testSettings_thumb1.png?imgmax=800" width="390" height="484" /&gt;&lt;/a&gt; &lt;/p&gt;&lt;p&gt;Create a new test project and fill in some tests. Again, the exact details here are not critical – just make sure you’ve got some tests that pass when you run them from Visual Studio.&lt;/p&gt;&lt;p&gt;&lt;a href="http://lh5.ggpht.com/_d41Ixos7YsM/TLXEJACDllI/AAAAAAAAALs/19v_YQA8L7g/s1600-h/testspasslocallyPNG3.png"&gt;&lt;img style="BORDER-RIGHT-WIDTH: 0px; DISPLAY: inline; BORDER-TOP-WIDTH: 0px; BORDER-BOTTOM-WIDTH: 0px; BORDER-LEFT-WIDTH: 0px" title="Tests pass locally" border="0" alt="Tests pass locally" src="http://lh3.ggpht.com/_d41Ixos7YsM/TLXEKzXyI9I/AAAAAAAAALw/7m08cILeasM/testspasslocallyPNG_thumb1.png?imgmax=800" width="644" height="195" /&gt;&lt;/a&gt; &lt;/p&gt;&lt;p&gt;Next you’ll have to create a build. Check you solution into source control. Then right click the builds node of the project and create a new build definition. Choose the workspace and the drop location, and leave everything else defaulted. This generates a standard build that will compile the database project and then run the unit tests. &lt;p&gt;Unfortunately, this build will only partially succeed – the unit tests will fail. This is due to the fact that the paths to the .dbproj and .dgen files are different during a TeamBuild than when we build in VS. So we have to modify the configs.&lt;/p&gt;&lt;p&gt;&lt;a href="http://lh4.ggpht.com/_d41Ixos7YsM/TLXENju0bAI/AAAAAAAAAL0/zXiFUsAJkLM/s1600-h/buildfailed3.png"&gt;&lt;img style="BORDER-RIGHT-WIDTH: 0px; DISPLAY: inline; BORDER-TOP-WIDTH: 0px; BORDER-BOTTOM-WIDTH: 0px; BORDER-LEFT-WIDTH: 0px" title="Build only partially succeeds" border="0" alt="Build only partially succeeds" src="http://lh5.ggpht.com/_d41Ixos7YsM/TLXEQdrasFI/AAAAAAAAAL4/8DAo39beE4Q/buildfailed_thumb1.png?imgmax=800" width="490" height="484" /&gt;&lt;/a&gt; &lt;a href="http://lh3.ggpht.com/_d41Ixos7YsM/TLXERqFXHzI/AAAAAAAAAL8/DHw2_zm2VEo/s1600-h/pathfailed3.png"&gt;&lt;img style="BORDER-RIGHT-WIDTH: 0px; DISPLAY: inline; BORDER-TOP-WIDTH: 0px; BORDER-BOTTOM-WIDTH: 0px; BORDER-LEFT-WIDTH: 0px" title="The deployment path is wrong" border="0" alt="The deployment path is wrong" src="http://lh6.ggpht.com/_d41Ixos7YsM/TLXETD1EetI/AAAAAAAAAMA/QOGKNFKmtOQ/pathfailed_thumb1.png?imgmax=800" width="644" height="148" /&gt;&lt;/a&gt;&lt;/p&gt;&lt;p&gt;Right click the app.config  of the Test Project. Copy and paste it so that you have a copy of the config. Rename this to &lt;em&gt;buildserver&lt;/em&gt;.dbunittest.config where &lt;em&gt;buildserver&lt;/em&gt; is the name of your build server (this could also be the name of the user running the build). The .dbunittest is important since TeamBuild looks for *.dbunittest.config if we override the default config.&lt;/p&gt;&lt;p&gt;Now remove all the tags except the &lt;DatabaseUnitTest&gt; and its contents. Make sure that the very 1st character of the file is the &lt;, else TeamBuild won’t read this config correctly. Add “..\Sources\” into the paths to the .dbproj file and .dgen files (just after the ..\..\).&lt;/p&gt;&lt;p&gt;&lt;span style="color:blue;"&gt;&lt;&lt;/span&gt;&lt;span style="color:#a31515;"&gt;DatabaseUnitTesting&lt;/span&gt;&lt;span style="color:blue;"&gt;&gt;&lt;br /&gt;    &lt;&lt;/span&gt;&lt;span style="color:#a31515;"&gt;DatabaseDeployment &lt;/span&gt;&lt;span style="color:red;"&gt;DatabaseProjectFileName&lt;/span&gt;&lt;span style="color:blue;"&gt;=&lt;/span&gt;"&lt;span style="color:blue;"&gt;..\..\..\Sources\TailspinToys\TailspinToys.dbproj&lt;/span&gt;"&lt;br /&gt;        &lt;span style="color:red;"&gt;Configuration&lt;/span&gt;&lt;span style="color:blue;"&gt;=&lt;/span&gt;"&lt;span style="color:blue;"&gt;Debug&lt;/span&gt;" &lt;span style="color:blue;"&gt;/&gt;&lt;br /&gt;    &lt;&lt;/span&gt;&lt;span style="color:#a31515;"&gt;DataGeneration &lt;/span&gt;&lt;span style="color:red;"&gt;DataGenerationFileName&lt;/span&gt;&lt;span style="color:blue;"&gt;=&lt;/span&gt;"&lt;span style="color:blue;"&gt;..\..\..\Sources\TailspinToys\Data Generation Plans\UnitTest.dgen&lt;/span&gt;"&lt;br /&gt;        &lt;span style="color:red;"&gt;ClearDatabase&lt;/span&gt;&lt;span style="color:blue;"&gt;=&lt;/span&gt;"&lt;span style="color:blue;"&gt;true&lt;/span&gt;" &lt;span style="color:blue;"&gt;/&gt;&lt;br /&gt;    &lt;&lt;/span&gt;&lt;span style="color:#a31515;"&gt;ExecutionContext &lt;/span&gt;&lt;span style="color:red;"&gt;Provider&lt;/span&gt;&lt;span style="color:blue;"&gt;=&lt;/span&gt;"&lt;span style="color:blue;"&gt;System.Data.SqlClient&lt;/span&gt;" &lt;span style="color:red;"&gt;ConnectionString&lt;/span&gt;&lt;span style="color:blue;"&gt;=&lt;/span&gt;"&lt;span style="color:blue;"&gt;Data Source=TRAIN-TFS;Initial Catalog=TailspinToys;Integrated Security=True;Pooling=False&lt;/span&gt;"&lt;br /&gt;        &lt;span style="color:red;"&gt;CommandTimeout&lt;/span&gt;&lt;span style="color:blue;"&gt;=&lt;/span&gt;"&lt;span style="color:blue;"&gt;30&lt;/span&gt;" &lt;span style="color:blue;"&gt;/&gt;&lt;br /&gt;    &lt;&lt;/span&gt;&lt;span style="color:#a31515;"&gt;PrivilegedContext &lt;/span&gt;&lt;span style="color:red;"&gt;Provider&lt;/span&gt;&lt;span style="color:blue;"&gt;=&lt;/span&gt;"&lt;span style="color:blue;"&gt;System.Data.SqlClient&lt;/span&gt;" &lt;span style="color:red;"&gt;ConnectionString&lt;/span&gt;&lt;span style="color:blue;"&gt;=&lt;/span&gt;"&lt;span style="color:blue;"&gt;Data Source=TRAIN-TFS;Initial Catalog=TailspinToys;Integrated Security=True;Pooling=False&lt;/span&gt;"&lt;br /&gt;        &lt;span style="color:red;"&gt;CommandTimeout&lt;/span&gt;&lt;span style="color:blue;"&gt;=&lt;/span&gt;"&lt;span style="color:blue;"&gt;30&lt;/span&gt;" &lt;span style="color:blue;"&gt;/&gt;&lt;br /&gt;&lt;/&lt;/span&gt;&lt;span style="color:#a31515;"&gt;DatabaseUnitTesting&lt;/span&gt;&lt;span style="color:blue;"&gt;&gt;&lt;br /&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;Open up the app.config in the Test project. Add AllowConfigurationOverride=”true” to the &lt;DatabaseUnitTest&gt; tag. This prompts TeamBuild to look for the config we created in the previous step.&lt;/p&gt;&lt;p&gt;&lt;span style="color:blue;"&gt;&lt;&lt;/span&gt;&lt;span style="color:#a31515;"&gt;DatabaseUnitTesting &lt;/span&gt;&lt;span style="color:red;"&gt;AllowConfigurationOverride&lt;/span&gt;&lt;span style="color:blue;"&gt;=&lt;/span&gt;"&lt;span style="color:blue;"&gt;true&lt;/span&gt;"&lt;span style="color:blue;"&gt;&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span style="color:blue;"&gt;&lt;br /&gt;&lt;a href="http://lh6.ggpht.com/_d41Ixos7YsM/TLXEThTmjQI/AAAAAAAAAME/0BQEbrTNHic/s1600-h/modifiedtestproject4.png"&gt;&lt;img style="BORDER-RIGHT-WIDTH: 0px; DISPLAY: inline; BORDER-TOP-WIDTH: 0px; BORDER-BOTTOM-WIDTH: 0px; BORDER-LEFT-WIDTH: 0px" title="Modified test project" border="0" alt="Modified test project" src="http://lh5.ggpht.com/_d41Ixos7YsM/TLXEUWQOH3I/AAAAAAAAAMI/KNjDzioKb10/modifiedtestproject_thumb2.png?imgmax=800" width="222" height="136" /&gt;&lt;/a&gt; &lt;/span&gt;&lt;/p&gt;&lt;a href="http://11011.net/software/vspaste"&gt;&lt;/a&gt;&lt;p&gt;Finally we need to create a new test settings file. Right click the Solution Items folder and add a new item – select the Test Settings item. You can name this whatever you want to and set whatever you want for your settings. The important bit here is to go to the “Deployment” tag and check the “Enable Deployment”. Then click the “Add” button and browse to the &lt;em&gt;buildserver&lt;/em&gt;.dbunittest.config file (you’ll have to change the file-type drop-down to *.*). Check in your solution.&lt;/p&gt;&lt;p&gt;&lt;a href="http://lh5.ggpht.com/_d41Ixos7YsM/TLXEVP_jh9I/AAAAAAAAAMM/q_8jj31KEMw/s1600-h/deploysettings4.png"&gt;&lt;img style="BORDER-RIGHT-WIDTH: 0px; DISPLAY: inline; BORDER-TOP-WIDTH: 0px; BORDER-BOTTOM-WIDTH: 0px; BORDER-LEFT-WIDTH: 0px" title="deploy settings" border="0" alt="deploy settings" src="http://lh3.ggpht.com/_d41Ixos7YsM/TLXEW5Nu4LI/AAAAAAAAAMQ/j0d8gQIOdWs/deploysettings_thumb2.png?imgmax=800" width="644" height="232" /&gt;&lt;/a&gt; &lt;/p&gt;&lt;p&gt;Check your solution into source control.&lt;/p&gt;&lt;p&gt;Finally we’ll modify the build. Edit the build definition that you created before. In the Process tab, click the ellipses after the Automated Test Settings to get the test settings dialogue. Set the Test Settings File to be the test settings we just created. If you can’t see the file, it may be that you haven’t checked it into source control – this browser browses source control, not your local drive.&lt;/p&gt;&lt;p&gt;&lt;a href="http://lh4.ggpht.com/_d41Ixos7YsM/TLXEXuI48DI/AAAAAAAAAMU/G4pOLXZ6m7E/s1600-h/configurebuildtestsettings3.png"&gt;&lt;img style="BORDER-RIGHT-WIDTH: 0px; DISPLAY: inline; BORDER-TOP-WIDTH: 0px; BORDER-BOTTOM-WIDTH: 0px; BORDER-LEFT-WIDTH: 0px" title="Configure build test settings" border="0" alt="Configure build test settings" src="http://lh3.ggpht.com/_d41Ixos7YsM/TLXEZsiXKCI/AAAAAAAAAMY/waoJeA41ilM/configurebuildtestsettings_thumb1.png?imgmax=800" width="644" height="252" /&gt;&lt;/a&gt; &lt;/p&gt;&lt;p&gt;Now queue a build and check that your tests are passing!&lt;/p&gt;&lt;p&gt;&lt;a href="http://lh6.ggpht.com/_d41Ixos7YsM/TLXEbMl8i4I/AAAAAAAAAMc/hxaV4dlmxiY/s1600-h/completed3.png"&gt;&lt;img style="BORDER-RIGHT-WIDTH: 0px; DISPLAY: inline; BORDER-TOP-WIDTH: 0px; BORDER-BOTTOM-WIDTH: 0px; BORDER-LEFT-WIDTH: 0px" title="completed" border="0" alt="completed" src="http://lh4.ggpht.com/_d41Ixos7YsM/TLXEd30ndbI/AAAAAAAAAMg/P36cUt6IXI4/completed_thumb1.png?imgmax=800" width="644" height="417" /&gt;&lt;/a&gt;&lt;/p&gt;</content>
  <ispublished>true</ispublished>
  <categories>
    <category>teambuild</category>
  </categories>
  <comments>
    <comment isAdmin="false" isApproved="true" id="f29878d9-4d37-485b-8f6b-9160be3aa439">
      <author>Anonymous</author>
      <email>noreply@blogger.com</email>
      <website></website>
      <ip></ip>
      <userAgent></userAgent>
      <date>2012-02-15 02:54:00</date>
      <content>Thanks for your post.  I could not get the alternative .config file to work with TFS Builds until I came to your page.  &lt;br /&gt;&lt;br /&gt;I did your steps, and I used the service account in the .config file name which is the service account that all our build agents utilize.  so, the .config file is .dbunittest.config.  This way, when running multiple build agents, there should be no issue of needing multiple .config files for each machine.&lt;br /&gt;&lt;br /&gt;I spent days trying to get this to work and was frustrated with this clunky way of getting this to work between my desktop and the TFS Build.</content>
    </comment>
    <comment isAdmin="false" isApproved="true" id="b80fa8c7-bab2-429f-8a07-bc09a9af7054">
      <author>Colin Dembovsky</author>
      <email>noreply@blogger.com</email>
      <website>http://www.blogger.com/profile/02577890234096457646</website>
      <ip></ip>
      <userAgent></userAgent>
      <date>2012-02-15 09:51:19</date>
      <content>Thanks for the feedback - and I feel your pain! It seems to me that MS sometimes has disconnect between the VS Feature teams and the TFS team (have you tried to use TeamBuild for Sharepoint dev? - you have to hack that to work too!). I'll make sure I pass this on to the MS product teams...</content>
    </comment>
  </comments>
  <viewCount>1916</viewCount>
</post>