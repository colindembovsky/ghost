<?xml version="1.0" encoding="utf-8"?>
<post>
  <id>3e48503a-f2cf-4afe-8cf9-c561539bd393</id>
  <title>More on Fakes – the beta has issues</title>
  <slug>more-on-fakes--the-beta-has-issues</slug>
  <shortUrl>http://bit.ly/1iJbToK</shortUrl>
  <author>Colin Dembovsky</author>
  <pubDate>2012-04-04 11:34:00</pubDate>
  <lastModified>2020-04-03 09:10:52</lastModified>
  <content>&lt;p&gt;Thanks to &lt;a href="http://www.peterprovost.org/blog/" target="_blank"&gt;Peter Provost&lt;/a&gt; for helping answer a couple of questions I had about Fakes – you can look at some of my code in my previous posts about &lt;a href="http://colinsalmcorner.blogspot.com/2012/03/using-fakes-framework-to-test-tfs-api.html" target="_blank"&gt;using Fakes with the TFS API&lt;/a&gt;.&lt;/p&gt; &lt;p&gt;There were two scenarios that I hit snags with. The first was faking methods in a class that are actually defined on the class’s base class. The second was faking an ObservableCollection&lt;T&gt;.&lt;/p&gt; &lt;h2&gt;Faking Base Class Methods&lt;/h2&gt; &lt;p&gt;Consider this code:&lt;/p&gt;&lt;pre class="brush: csharp; ruler: true;"&gt;[TestMethod]&lt;br /&gt;public void BaseMethodWontWorkInBeta()&lt;br /&gt;{&lt;br /&gt;    using (ShimsContext.Create())&lt;br /&gt;    {&lt;br /&gt;        var shimWorkItemStore = new ShimWorkItemStore();&lt;br /&gt;        var shimTfsTeamProjectCollection = new ShimTfsTeamProjectCollection();&lt;br /&gt;        var shimTfsConnection = new ShimTfsConnection(shimTfsTeamProjectCollection);&lt;br /&gt;        shimTfsConnection.GetServiceOf1&lt;WorkItemStore&gt;(() =&gt; shimWorkItemStore);&lt;br /&gt;&lt;br /&gt;        var workItemStore = shimTfsTeamProjectCollection.Instance.GetService&lt;WorkItemStore&gt;();&lt;br /&gt;&lt;br /&gt;        Assert.AreSame(shimWorkItemStore.Instance, workItemStore);&lt;br /&gt;    }&lt;br /&gt;}&lt;/pre&gt;&lt;br /&gt;&lt;p&gt;The exercise here is to try to fake the TfsTeamProjectCollection.GetService&lt;T&gt; method. However, we can’t do it directly on the TfsTeamProjectCollection object, since the method is defined in its base class, TfsConnection.&lt;/p&gt;&lt;br /&gt;&lt;p&gt;In line 8, we’re using the ShimTfsConnection constructor that takes in an instance of its child class (the TfsTeamProjectCollection) in order to override the method in the child class. This should work, but Peter told me that this doesn’t work in the Beta – it’ll work when the next release of fakes comes out. The workaround is to use the ShimTfsConnection.AllInstances class to override the GetService&lt;T&gt; method (see my earlier posts where I show how to do this).&lt;/p&gt;&lt;br /&gt;&lt;h2&gt;Faking ObservableCollection&lt;T&gt;&lt;/h2&gt;&lt;br /&gt;&lt;p&gt;Let’s look at some more code:&lt;/p&gt;&lt;pre class="brush: csharp; ruler: true;"&gt;[TestMethod]&lt;br /&gt;public void BindWontWorkBecauseOfObservableCollectionInBeta()&lt;br /&gt;{&lt;br /&gt;    using (ShimsContext.Create())&lt;br /&gt;    {&lt;br /&gt;        var ss = new StubISharedStep();&lt;br /&gt;        var sharedStepReference = new StubISharedStepReference&lt;br /&gt;        {&lt;br /&gt;            FindSharedStep = () =&gt; ss&lt;br /&gt;        };&lt;br /&gt;&lt;br /&gt;        var actions = new List&lt;ITestAction&gt;&lt;br /&gt;        {&lt;br /&gt;            sharedStepReference&lt;br /&gt;        };&lt;br /&gt;&lt;br /&gt;        var fakeTestActions = new ShimTestActionCollection();&lt;br /&gt;        fakeTestActions.Bind((IList&lt;ITestAction&gt;)actions);&lt;br /&gt;&lt;br /&gt;        Assert.AreEqual(1, fakeTestActions.Instance.Count);&lt;br /&gt;&lt;br /&gt;        var ssr = (ISharedStepReference)(fakeTestActions.Instance[0]);&lt;br /&gt;        Assert.AreSame(sharedStepReference, ssr);&lt;br /&gt;&lt;br /&gt;        Assert.AreSame(ss, ssr.FindSharedStep());&lt;br /&gt;    }&lt;br /&gt;}&lt;/pre&gt;&lt;br /&gt;&lt;p&gt;The point of this code is to try to fake a TestActionCollection, which is an ObservableCollection&lt;ITestAction&gt;. I had successfully managed to fake other collections that were not ObservableCollections (like a WorkItemCollection), and to do that I used the Bind() method of the Shim to bind the fake collection to a list of items. However, I couldn’t get the code to work on the ObservableCollection&lt;T&gt;. (In the above code, I get a NullReferenceException on line 18 when calling the Bind() method.&lt;/p&gt;&lt;br /&gt;&lt;p&gt;Peter confirmed that the reason for this is twofold: one, I hadn’t added Fakes for System, which is where the ObservableCollection&lt;T&gt; class resides. This is a performance optimization that the Fakes creation employs so that they don’t create fakes for classes that you’ll never use.&lt;/p&gt;&lt;br /&gt;&lt;p&gt;Secondly, and rather unfortunately, even adding that Fake doesn’t work in the Beta. The Fakes creation uses a white-list to generate fakes in the System namespace, and the ObservableCollection&lt;T&gt; isn’t on the white-list in the Beta. In the next release, the System white-list will be customizable, so I am looking forward to getting my grubby paws on that!&lt;/p&gt;&lt;br /&gt;&lt;p&gt;Unfortunately, this scenario has no work-around in the Beta, so if you’re trying to Fake an ObservableCollection&lt;T&gt;, you’ll have to wait for the next release of Fakes.&lt;/p&gt;&lt;br /&gt;&lt;p&gt;I really like the Fakes framework and what it can do for testing, so I am looking forward to seeing what else comes out of the woodwork.&lt;/p&gt;&lt;br /&gt;&lt;p&gt;Happy faking!&lt;/p&gt;  </content>
  <ispublished>true</ispublished>
  <categories>
    <category>Testing</category>
  </categories>
  <comments></comments>
  <viewCount>1839</viewCount>
</post>