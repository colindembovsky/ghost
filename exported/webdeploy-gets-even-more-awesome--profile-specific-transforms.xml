<?xml version="1.0" encoding="utf-8"?>
<post>
  <id>37daa003-330d-42dd-8666-fc51151edeea</id>
  <title>WebDeploy Gets Even More Awesome – Profile Specific Transforms</title>
  <slug>webdeploy-gets-even-more-awesome--profile-specific-transforms</slug>
  <shortUrl>http://bit.ly/1koAJrI</shortUrl>
  <author>Colin Dembovsky</author>
  <pubDate>2014-04-23 09:37:00</pubDate>
  <lastModified>2020-04-05 14:56:37</lastModified>
  <content>&lt;p&gt;I love WebDeploy – I have ever since I read Scott Hanselman’s post &lt;a href="http://www.hanselman.com/blog/WebDeploymentMadeAwesomeIfYoureUsingXCopyYoureDoingItWrong.aspx" target="_blank"&gt;“Web Deploy Made Awesome: If You’re Using XCopy, You’re Doing It Wrong”&lt;/a&gt;. Whenever I’m helping teams that build web applications improve their ALM processes, invariable I end up moving them onto Web Deploy. Not only is it an easier and cleaner way to deploy, but you get the bonus of being able to manage configuration files (Web.config) in your project. &lt;/p&gt; &lt;h2&gt;Config as Code&lt;/h2&gt; &lt;p&gt;Maturing in ALM means that you need to head towards continuous deployment. You need to be able to deploy your application with a single click of a button. However, one challenge with this is managing configurations. How do you manage Web.config files in dev, UAT and Production environments? Do you find yourself copying config files out the way before you deploy? That’s BAD. You should be managing your configs as if they were code. They need to be source controlled.&lt;/p&gt; &lt;p&gt;Fair enough, I hear you say. So you’ll just copy all your config files from all your servers into a folder and manage them from there. Better – but still lots of pain. A far better approach is to use config transforms.&lt;/p&gt; &lt;p&gt;Config transforms came into web applications in VS 2010. With the latest release of VS 2013, not only are they also available for web sites (NOTE: please don’t use websites – always use web applications!) but you can new preview your transforms from VS and there’s now support for profile-specific transforms.&lt;/p&gt; &lt;p&gt;Let’s have a look at a config transform in a newly created MVC web application. You can see that the Web.config file expands to show 2 other files – one per project configuration:&lt;/p&gt; &lt;p&gt;&lt;a href="http://lh6.ggpht.com/-YGiHKqsIuZ8/U1dtkN4GlOI/AAAAAAAABV0/b3mj46J2nIU/s1600-h/image%25255B2%25255D.png"&gt;&lt;img title="image" style="border-top: 0px; border-right: 0px; border-bottom: 0px; float: none; margin-left: auto; border-left: 0px; display: block; margin-right: auto" border="0" alt="image" src="http://lh5.ggpht.com/-lJ00JDqtfSc/U1dtlA39wWI/AAAAAAAABV8/cTDXA9jNxVM/image_thumb.png?imgmax=800" width="189" height="70"&gt;&lt;/a&gt; &lt;/p&gt; &lt;p&gt;If you add project configurations, then you can right-click the Web.config and select “Add config Transforms” and VS will create a new transform file for you.&lt;/p&gt; &lt;p&gt;Let’s have a look at the Web.Release.config (I’ve removed the comments that are auto-generated):&lt;/p&gt;&lt;pre class="brush: xml;"&gt;&lt;configuration xmlns:xdt="http://schemas.microsoft.com/XML-Document-Transform"&gt;
  &lt;system.web&gt;
    &lt;compilation xdt:Transform="RemoveAttributes(debug)" /&gt;
  &lt;/system.web&gt;
&lt;/configuration&gt;
&lt;/pre&gt;&lt;br /&gt;&lt;p&gt;You can see that in the &lt;compilation&gt; tag there’s an xdt:Transform to remove the debug attribute. When applied, the transform uses the structure of the transform file to find the correct element and perform the necessary transforms – whether it’s an insert, a remove or some other transform. You can read about the syntax for transforms &lt;a href="http://msdn.microsoft.com/en-us/library/dd465326(v=vs.110).aspx" target="_blank"&gt;here&lt;/a&gt;. Note that when you debug out of VS, your application will use the Web.config file irrespective of if you’re running in Debug or Release – the transforms only happen when you publish or package your web app.&lt;/p&gt;&lt;br /&gt;&lt;p&gt;This is all existing “2012” stuff. What’s new in the latest release?&lt;/p&gt;&lt;br /&gt;&lt;h2&gt;Preview and Profile Specific Transforms&lt;/h2&gt;&lt;br /&gt;&lt;p&gt;You can now preview your transform by right-clicking on the transform file (Web.Release.config, for example) and selecting “Preview Transform”. This immediately shows a diff – the original Web.config on the left and the transformed config on the right:&lt;/p&gt;&lt;br /&gt;&lt;p&gt;&lt;a href="http://lh3.ggpht.com/-FRvfdnnlHAU/U1dtmdB-kTI/AAAAAAAABWE/f8OzAWgYOP4/s1600-h/image%25255B6%25255D.png"&gt;&lt;img title="image" style="border-top: 0px; border-right: 0px; border-bottom: 0px; float: none; margin-left: auto; border-left: 0px; display: block; margin-right: auto" border="0" alt="image" src="http://lh6.ggpht.com/-8nl4r4oTsmA/U1dtn3KHksI/AAAAAAAABWM/r2Awo15BsdI/image_thumb%25255B2%25255D.png?imgmax=800" width="360" height="214"&gt;&lt;/a&gt; &lt;/p&gt;&lt;br /&gt;&lt;p&gt;Now you can debug your transforms!&lt;/p&gt;&lt;br /&gt;&lt;p&gt;So let’s imagine you have a UAT environment. You want to publish your site, so you create a new project configuration called UAT. You then copy the release transforms and put in your UAT connection strings and so on. After doing some testing in UAT, you realize that you actually need to debug, so you’ll have to update your Web.UAT.config file again, or create a UAT-DEBUG project configuration. Soon you’ll get lots of project configurations, and that’s just a mess.&lt;/p&gt;&lt;br /&gt;&lt;p&gt;However, you can now create a profile-specific transform on top of the project configuration transforms! Let’s create a publish profile. I’ll right-click the web project and select “Publish”. I’ll create a new profile called “UAT-Debug” and give it whatever settings I need to. On the “Configuration” page, I’ll change the configuration from Release to Debug.&lt;/p&gt;&lt;br /&gt;&lt;p&gt;&lt;a href="http://lh6.ggpht.com/-Ed1Le7fHzUI/U1dtokAE42I/AAAAAAAABWU/z01rc2Sh_4Q/s1600-h/image%25255B10%25255D.png"&gt;&lt;img title="image" style="border-top: 0px; border-right: 0px; border-bottom: 0px; float: none; margin-left: auto; border-left: 0px; display: block; margin-right: auto" border="0" alt="image" src="http://lh6.ggpht.com/-CNFnS-2x-tM/U1dtpdKZjwI/AAAAAAAABWc/VmX_sjROfCU/image_thumb%25255B4%25255D.png?imgmax=800" width="303" height="242"&gt;&lt;/a&gt; Then I’ll click on “Close” to save the profile without publishing. That will create a pubxml file for me. I’ll repeat the process and create a publish profile called “UAT-Release”. Looking under the Properties of my project I’ll see the pubxml files:&lt;/p&gt;&lt;br /&gt;&lt;p&gt;&lt;a href="http://lh3.ggpht.com/-TMI7lv6iMsE/U1dtqMIv9fI/AAAAAAAABWk/hV7eh3j_V5g/s1600-h/image%25255B16%25255D.png"&gt;&lt;img title="image" style="border-top: 0px; border-right: 0px; border-bottom: 0px; float: none; margin-left: auto; border-left: 0px; display: block; margin-right: auto" border="0" alt="image" src="http://lh6.ggpht.com/-bQ7HqTRb49w/U1dtq7Yb5TI/AAAAAAAABWs/380jDzBBqs0/image_thumb%25255B6%25255D.png?imgmax=800" width="222" height="147"&gt;&lt;/a&gt; &lt;/p&gt;&lt;br /&gt;&lt;p&gt;Now I can right-click a pubxml and select “Add Config Transform” – which creates a new transform for me that’s tied to this publish profile.&lt;/p&gt;&lt;br /&gt;&lt;p&gt;&lt;a href="http://lh4.ggpht.com/-73XD-8jNbg8/U1dtrpPahzI/AAAAAAAABW0/UlSYjbBx8Gs/s1600-h/image%25255B19%25255D.png"&gt;&lt;img title="image" style="border-top: 0px; border-right: 0px; border-bottom: 0px; float: none; margin-left: auto; border-left: 0px; display: block; margin-right: auto" border="0" alt="image" src="http://lh4.ggpht.com/-4a-PCyFWa5M/U1dtsp7CUWI/AAAAAAAABW8/btc9n2ZAEuA/image_thumb%25255B7%25255D.png?imgmax=800" width="244" height="163"&gt;&lt;/a&gt; I’ll create one for each profile. You’ll see that I now have 4 transforms (but still only 2 project configurations – hooray!)&lt;/p&gt;&lt;br /&gt;&lt;p&gt;&lt;a href="http://lh4.ggpht.com/-zHhXxUy9JCo/U1dttULnqJI/AAAAAAAABXE/_UZ1iOC2OBo/s1600-h/image%25255B22%25255D.png"&gt;&lt;img title="image" style="border-top: 0px; border-right: 0px; border-bottom: 0px; float: none; margin-left: auto; border-left: 0px; display: block; margin-right: auto" border="0" alt="image" src="http://lh4.ggpht.com/-9zZ2EkJIfMU/U1dtt7iVk8I/AAAAAAAABXM/hPFKWV-21ak/image_thumb%25255B8%25255D.png?imgmax=800" width="207" height="105"&gt;&lt;/a&gt; &lt;/p&gt;&lt;br /&gt;&lt;p&gt;Let’s insert an attribute in both of the new config files:&lt;/p&gt;&lt;pre class="brush: xml;"&gt;&lt;appSettings&gt;
  &lt;add key="Profile" value="UAT-debug" xdt:Transform="Insert"/&gt;
&lt;/appSettings&gt;
&lt;/pre&gt;&lt;br /&gt;&lt;p&gt;I’ve also removed the debug attribute from the compilation tag on the UAT-Release config and removed that transform from the debug one:&lt;/p&gt;&lt;br /&gt;&lt;p&gt;&lt;a href="http://lh4.ggpht.com/-EF7G_5Bhsek/U1dtuykRrZI/AAAAAAAABXU/XeErJsRZPCs/s1600-h/image%25255B26%25255D.png"&gt;&lt;img title="image" style="border-top: 0px; border-right: 0px; border-bottom: 0px; float: none; margin-left: auto; border-left: 0px; display: block; margin-right: auto" border="0" alt="image" src="http://lh3.ggpht.com/-uKlJh1sJ63A/U1dtvvQRWSI/AAAAAAAABXc/K16S2zGhATg/image_thumb%25255B10%25255D.png?imgmax=800" width="352" height="94"&gt;&lt;/a&gt; &lt;/p&gt;&lt;br /&gt;&lt;p&gt;Now when I right-click Web.UAT-Release.config and select “Preview Transform” I can see the diff. Note that the right-hand file tells me that it has actually applied 2 transforms: first the Release transform (since the profile specifies Release for the project configuration) and secondly the Web.UAT-Release.config transforms themselves.&lt;/p&gt;&lt;br /&gt;&lt;p&gt;&lt;a href="http://lh4.ggpht.com/-iVpv87hfRIk/U1dtxAZ8FJI/AAAAAAAABXk/4105KU36sOA/s1600-h/image%25255B30%25255D.png"&gt;&lt;img title="image" style="border-top: 0px; border-right: 0px; border-bottom: 0px; float: none; margin-left: auto; border-left: 0px; display: block; margin-right: auto" border="0" alt="image" src="http://lh4.ggpht.com/-iYnIq-p7JFI/U1dty8jNAJI/AAAAAAAABXs/_y_vP11HLBo/image_thumb%25255B12%25255D.png?imgmax=800" width="326" height="193"&gt;&lt;/a&gt; Voila! I can now maintain 2 project configurations (Debug and Release) and have a publish profile and transform config per project config and environment. Awesome!&lt;/p&gt;&lt;br /&gt;&lt;p&gt;If you’re using Release Management, don’t forget to check out my post about &lt;a href="http://www.colinsalmcorner.com/2013/11/webdeploy-and-release-management.html" target="_blank"&gt;how to use config transforms for parameterizing releases&lt;/a&gt;!&lt;/p&gt;&lt;br /&gt;&lt;p&gt;Happy transforming!&lt;/p&gt;  </content>
  <ispublished>true</ispublished>
  <categories>
    <category>Release Management</category>
  </categories>
  <comments>
    <comment isAdmin="false" isApproved="true" id="5a577f02-0e94-4e9d-9248-f82c36c84951">
      <author>Dylan Smith</author>
      <email>noreply@blogger.com</email>
      <website>http://www.geekswithblogs.net/optikal</website>
      <ip></ip>
      <userAgent></userAgent>
      <date>2014-04-23 10:8:33</date>
      <content>When you create configurations for each environment (to use the transforms) that means you have to compile your code multiple times right? Once for each configuration?&lt;br /&gt;&lt;br /&gt;That was my understanding and that sucks, what I really want to do is compile my code once, then create packages (and apply transforms) for each environment so I'm deploying the same binaries to each.  I've done this in the past by doing the XDT Transforms myself via my deployment scripts.</content>
    </comment>
    <comment isAdmin="false" isApproved="true" id="a59a3d50-aa74-482e-ad70-662d94003b08">
      <author>Colin Dembovsky</author>
      <email>noreply@blogger.com</email>
      <website>http://www.blogger.com/profile/02577890234096457646</website>
      <ip></ip>
      <userAgent></userAgent>
      <date>2014-04-23 13:5:02</date>
      <content>Hi Dylan&lt;br /&gt;&lt;br /&gt;Yes - if you're building the packages using build, you'd have to compile once for every configuration. Since the build is using the same code, there's little risk (make sure you version your assemblies) even if you compile for numerous configurations. Otherwise have a look at my WebDeploy and Release Management post for how to create a parameterized package where you can fill in the values at deployment time (using WebDeploys Settings.xml file).</content>
    </comment>
  </comments>
  <viewCount>49100</viewCount>
</post>