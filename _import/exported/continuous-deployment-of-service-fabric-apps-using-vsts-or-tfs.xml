<?xml version="1.0" encoding="utf-8"?>
<post>
  <id>381e0e17-64e3-42e4-a4b6-b259216df0a6</id>
  <title>Continuous Deployment of Service Fabric Apps using VSTS (or TFS)</title>
  <slug>continuous-deployment-of-service-fabric-apps-using-vsts-or-tfs</slug>
  <shortUrl>http://bit.ly/1Uj4MpK</shortUrl>
  <author></author>
  <pubDate>2016-04-28 12:41:34</pubDate>
  <lastModified>2018-07-18 19:55:29</lastModified>
  <content>&lt;p&gt;Azure’s &lt;a href="https://azure.microsoft.com/en-us/documentation/articles/service-fabric-overview/" target="_blank"&gt;Service Fabric&lt;/a&gt; is breathtaking – the platform allows you to create truly “born in the cloud” apps that can &lt;em&gt;really&lt;/em&gt; scale. The platform takes care of the plumbing for you so that you can concentrate on business value in your apps. If you’re looking to create cloud apps, then make sure you take some time to investigate Service Fabric.&lt;/p&gt; &lt;h2&gt;Publishing Service Fabric Apps&lt;/h2&gt; &lt;p&gt;Unfortunately, most of the samples (like this &lt;a href="https://github.com/azure-samples/service-fabric-dotnet-getting-started" target="_blank"&gt;getting started one&lt;/a&gt; or this more &lt;a href="https://github.com/Azure-Samples/service-fabric-dotnet-web-reference-app" target="_blank"&gt;real-world one&lt;/a&gt;) don’t offer any guidance around continuous deployment. They just wave hands and say, “Publish from Visual Studio” or “Publish using PowerShell”. Which is all well and good – but how do you actually do proper DevOps with ServiceFabric Apps?&lt;/p&gt; &lt;p&gt;Publishing apps to Service Fabric requires that you &lt;em&gt;package&lt;/em&gt; the app and then &lt;em&gt;publish&lt;/em&gt; it. Fortunately VSTS allows you to fairly easily package the app in an automated build and then publish the app in a release.&lt;/p&gt; &lt;p&gt;There are two primary challenges to doing this:&lt;/p&gt; &lt;ol&gt; &lt;li&gt;Versioning. Versioning is critical to Service Fabric apps, so your automated build is going to have to know how to version the app (and its constituent services) correctly  &lt;li&gt;Publishing – new vs upgrade. The out-of-the-box publish script (that you get when you do a File-&amp;gt;New Service Fabric App project) needs to be invoked differently for new apps as opposed to upgrading existing apps. In the pipeline, you want to be able to publish the same way – whether or not the application already exists. Fortunately a couple modifications to the publish script do the trick.&lt;/li&gt;&lt;/ol&gt; &lt;p&gt;Finally, the cluster should be created or updated on the fly during the release – that’s what the ARM templates do.&lt;/p&gt; &lt;p&gt;To demonstrate a Service Fabric build/release pipeline, I’m going to use a “fork” of the original &lt;a href="https://github.com/Azure-Samples/service-fabric-dotnet-getting-started/tree/master/Actors/VisualObjects" target="_blank"&gt;VisualObjects&lt;/a&gt; sample from the &lt;a href="https://github.com/Azure-Samples/service-fabric-dotnet-getting-started" target="_blank"&gt;getting started repo&lt;/a&gt; (it’s not a complete fork since I just wanted this one solution from the repo). I’ve added an ARM template project to demonstrate how to create the cluster using ARM during the deployment and then I’ve added two publishing profiles – one for Test and one for Prod. The ARM templates and profiles for both Test and Prod are exactly the same in the repo – in real life you’ll have a beefier cluster in Prod (with different application parameters) than you will in test, so the ARM templates and profiles are going to look different. Having two templates and profiles gives you the idea of how to separate environments in the Release, which is all I want to demonstrate.&lt;/p&gt; &lt;p&gt;This entire flow works on TFS as well as VSTS, so I’m just going to show you how to do this using VSTS. I’ll call out differences for TFS when necessary.&lt;/p&gt; &lt;h3&gt;Getting the Code&lt;/h3&gt; &lt;p&gt;The easiest way is to just fork &lt;a href="https://github.com/colindembovsky/ServiceFabricBuildRelease" target="_blank"&gt;this repo&lt;/a&gt; on Github. You can of course clone the repo, then push it to a VSTS project if you prefer. For this post I’m going to use code that I’ve imported into a VSTS repo. If you’re on TFS, then it’s probably easiest to clone the repo and push it to your TFS server.&lt;/p&gt; &lt;h2&gt;Setting up the Build&lt;/h2&gt; &lt;p&gt;Unfortunately the Service Fabric SDK isn’t installed on the hosted agent image in VSTS, so you’ll have to use a private agent. Make sure the Service Fabric SDK is installed on the build machine. Use this &lt;a href="https://azure.microsoft.com/en-us/documentation/articles/service-fabric-get-started/" target="_blank"&gt;help doc&lt;/a&gt; to get the bits.&lt;/p&gt; &lt;p&gt;The next thing you’ll need is my &lt;a href="https://github.com/colindembovsky/cols-agent-tasks/tree/master/Tasks/VersionAssemblies" target="_blank"&gt;VersionAssemblies custom build task&lt;/a&gt;. I’ve bundled it into a &lt;a href="https://marketplace.visualstudio.com/items?itemName=colinsalmcorner.colinsalmcorner-buildtasks" target="_blank"&gt;VSTS marketplace extension&lt;/a&gt;. If you’re on VSTS, just click “Install” – if you’re on TFS, you’ll need to download it and upload it. You’ll only be able to do this on TFS 2015 Update 2 or later.&lt;/p&gt; &lt;p&gt;Now go to your VSTS account and navigate to the Code hub. Create a new Build definition using the Visual Studio template. Select the appropriate source repo and branch (I’m just going to use master) and select the queue with your private agent. Select Continuous Integration to queue the build whenever a commit is pushed to the repo:&lt;/p&gt; &lt;p&gt;&lt;a href="http://www.colinsalmcorner.com/posts/files/a1859eb3-7f2a-4937-be6c-a49dba822a8d.png"&gt;&lt;img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; float: none; padding-top: 0px; padding-left: 0px; margin-left: auto; display: block; padding-right: 0px; border-top-width: 0px; margin-right: auto" border="0" alt="image" src="http://www.colinsalmcorner.com/posts/files/4a7acc11-01a8-47da-acaf-ad96ddc03ac0.png" width="428" height="426"&gt;&lt;/a&gt;&lt;/p&gt; &lt;p&gt;&amp;nbsp;&lt;/p&gt; &lt;p&gt;Change the name of the build – I’ve called mine “VisualObjects”. Go to the General tab and change the build number format to be &lt;/p&gt; &lt;p&gt;&lt;font face="Courier New"&gt;1.0$(rev:.r)&lt;/font&gt;&lt;/p&gt; &lt;p&gt;This will give the build number 1.0.1, then 1.0.2, 1.0.3 and so on.&lt;/p&gt; &lt;p&gt;Now we want to change the build so that it will match the ApplicationTypeVersion (from the application manifest) and all the Service versions within the ServiceManifests for each service within the application. So click “Add Task” and add two “VersionAssembly” tasks. Drag them to the top of the build (so that they are the first two tasks executed).&lt;/p&gt; &lt;p&gt;Configure the first one as follows:&lt;/p&gt; &lt;p&gt;&lt;a href="http://www.colinsalmcorner.com/posts/files/4354826f-09b8-44e2-a2c5-d9d248012266.png"&gt;&lt;img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; float: none; padding-top: 0px; padding-left: 0px; margin-left: auto; display: block; padding-right: 0px; border-top-width: 0px; margin-right: auto" border="0" alt="image" src="http://www.colinsalmcorner.com/posts/files/8122a0ca-f3c9-4819-b976-fe95f71ab0ce.png" width="522" height="255"&gt;&lt;/a&gt;&lt;/p&gt; &lt;p&gt;Configure the second one as follows:&lt;/p&gt; &lt;p&gt;&lt;a href="http://www.colinsalmcorner.com/posts/files/2f967a07-15ca-493c-bea0-2279e02acd5c.png"&gt;&lt;img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; float: none; padding-top: 0px; padding-left: 0px; margin-left: auto; display: block; padding-right: 0px; border-top-width: 0px; margin-right: auto" border="0" alt="image" src="http://www.colinsalmcorner.com/posts/files/99b52c32-9907-4ad7-ac8b-674d86250a32.png" width="525" height="256"&gt;&lt;/a&gt;&lt;/p&gt; &lt;p&gt;The first task finds the ApplicationManifest.xml file and replaces the version with the build number. The second task recursively finds all the ServiceManifest.xml files and then also replaces the version number of each service with the build number. After the build, the application and service versions will all match the build number.&lt;/p&gt; &lt;p&gt;The next 3 tasks should be “NuGet Installer”, “Visual Studio Build” and “Visual Studio Test”. You can leave those as is.&lt;/p&gt; &lt;p&gt;Add a new “Visual Studio Build” task and place it just below the test task. Configure the Solution parameter to the path of the .sfproj in the solution (src/VisualObjects/VisualObjects/VisualObjects.sfproj). Make the MSBuild Arguments parameter “/t:Package). Finally, add $(BuildConfiguration) to the Configuration parameter. This task invokes Visual Studio to package the Service Fabric app:&lt;/p&gt; &lt;p&gt;&lt;a href="http://www.colinsalmcorner.com/posts/files/14608904-483f-496c-9218-15c366b5d685.png"&gt;&lt;img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; float: none; padding-top: 0px; padding-left: 0px; margin-left: auto; display: block; padding-right: 0px; border-top-width: 0px; margin-right: auto" border="0" alt="image" src="http://www.colinsalmcorner.com/posts/files/dd5d1ce8-3ff4-4c9d-96c0-72481c6c2576.png" width="504" height="225"&gt;&lt;/a&gt;&lt;/p&gt; &lt;p&gt;Now you’ll need to do some copying so that we get all the files we need into the artifact staging directory, ready for publishing. Add a couple “Copy” tasks to the build and configure them as follows:&lt;/p&gt; &lt;p&gt;&lt;a href="http://www.colinsalmcorner.com/posts/files/25e4f774-60ad-46a7-9258-38be03773928.png"&gt;&lt;img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; float: none; padding-top: 0px; padding-left: 0px; margin-left: auto; display: block; padding-right: 0px; border-top-width: 0px; margin-right: auto" border="0" alt="image" src="http://www.colinsalmcorner.com/posts/files/7dc9fa90-26f4-4c43-824a-64b16fbe41d4.png" width="498" height="95"&gt;&lt;/a&gt;&lt;/p&gt; &lt;p&gt;This copies the Service Fabric app package to the staging directory.&lt;/p&gt; &lt;p&gt;&lt;a href="http://www.colinsalmcorner.com/posts/files/277b9095-4897-4410-b44a-67af02bc3389.png"&gt;&lt;img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; float: none; padding-top: 0px; padding-left: 0px; margin-left: auto; display: block; padding-right: 0px; border-top-width: 0px; margin-right: auto" border="0" alt="image" src="http://www.colinsalmcorner.com/posts/files/8eb44813-6d32-420a-8cc1-2421c9b7376e.png" width="499" height="95"&gt;&lt;/a&gt;&lt;/p&gt; &lt;p&gt;This copies the Scripts folder to the staging directory (we’ll need this in the release to publish the app).&lt;/p&gt; &lt;p&gt;&lt;a href="http://www.colinsalmcorner.com/posts/files/4f246bbb-567b-4338-95b1-86091360c51a.png"&gt;&lt;img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; float: none; padding-top: 0px; padding-left: 0px; margin-left: auto; display: block; padding-right: 0px; border-top-width: 0px; margin-right: auto" border="0" alt="image" src="http://www.colinsalmcorner.com/posts/files/e7d5f48e-3e9f-4679-a22a-fb6e617badce.png" width="497" height="90"&gt;&lt;/a&gt;&lt;/p&gt; &lt;p&gt;&lt;a href="http://www.colinsalmcorner.com/posts/files/fe5104b1-f723-4667-b0bb-fabfe59965be.png"&gt;&lt;img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; float: none; padding-top: 0px; padding-left: 0px; margin-left: auto; display: block; padding-right: 0px; border-top-width: 0px; margin-right: auto" border="0" alt="image" src="http://www.colinsalmcorner.com/posts/files/57a3cd79-ebc2-4fa8-bd8b-fc0ba3d6542e.png" width="495" height="92"&gt;&lt;/a&gt;&lt;/p&gt; &lt;p&gt;These tasks copy the Publish Profiles and ApplicationParameters files to the staging directory. Again, these are needed for the release.&lt;/p&gt; &lt;p&gt;You’ll notice that there isn’t a copy task for the ARM project – that’s because the ARM project automagically puts its output into the staging directory for you when building the solution.&lt;/p&gt; &lt;p&gt;You can remove the Source Symbols task if you want to – it’s not going to harm anything if it’s there. If you really want to keep the symbols you’ll have to specify a network share for the symbols to be copied to.&lt;/p&gt; &lt;p&gt;Finally, make sure that your “Publish Build Artifacts” task is configured like this:&lt;/p&gt; &lt;p&gt;&lt;a href="http://www.colinsalmcorner.com/posts/files/d65f9c73-a569-4b82-887f-246cb6823c2b.png"&gt;&lt;img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; float: none; padding-top: 0px; padding-left: 0px; margin-left: auto; display: block; padding-right: 0px; border-top-width: 0px; margin-right: auto" border="0" alt="image" src="http://www.colinsalmcorner.com/posts/files/17e165bf-d097-4bc0-96b9-fab4ca7e1304.png" width="498" height="82"&gt;&lt;/a&gt;&lt;/p&gt; &lt;p&gt;Of course you can also choose a network folder rather than a server drop if you want. The tasks should look like this:&lt;/p&gt; &lt;p&gt;&lt;a href="http://www.colinsalmcorner.com/posts/files/38590fa3-9e30-455e-b727-601734367fe0.png"&gt;&lt;img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; float: none; padding-top: 0px; padding-left: 0px; margin-left: auto; display: block; padding-right: 0px; border-top-width: 0px; margin-right: auto" border="0" alt="image" src="http://www.colinsalmcorner.com/posts/files/94c65e36-bd1f-425b-906a-c03cb0f048d6.png" width="296" height="322"&gt;&lt;/a&gt;&lt;/p&gt; &lt;p&gt;Run the build to make sure that it’s all happy. The artifacts folder should look like this:&lt;/p&gt; &lt;p&gt;&lt;a href="http://www.colinsalmcorner.com/posts/files/7a0e92a5-c56d-43d4-a725-8cf01ddbf37d.png"&gt;&lt;img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; float: none; padding-top: 0px; padding-left: 0px; margin-left: auto; display: block; padding-right: 0px; border-top-width: 0px; margin-right: auto" border="0" alt="image" src="http://www.colinsalmcorner.com/posts/files/f48745e5-8e7e-4a99-9fa3-4eade351e3dd.png" width="310" height="369"&gt;&lt;/a&gt;&lt;/p&gt; &lt;h2&gt;Setting up the Release&lt;/h2&gt; &lt;p&gt;Now that the app is packaged, we’re almost ready to define the release pipeline. There’s a decision to make at this point: to ARM or not to ARM. In order to create the Azure Resource Group containing the cluster from the ARM template, VSTS will need a secure connection to the Azure subscription (follow &lt;a href="https://blogs.msdn.microsoft.com/visualstudioalm/2015/10/04/automating-azure-resource-group-deployment-using-a-service-principal-in-visual-studio-online-buildrelease-management/" target="_blank"&gt;these instructions&lt;/a&gt;). This connection is service principal based, so you need to have an AAD backing your Azure subscription and you need to have permissions to add new applications to the AAD (being an administrator or co-admin will work – there may be finer-grained RBAC roles for this, I’m not sure). However, if you don’t have an AAD backing your subscription or can’t create applications, you can manually create the cluster in your Azure subscription. Do so now if you’re going to create the cluster(s) manually (one for Test, one for Prod).&lt;/p&gt; &lt;p&gt;To create the release definition, go to the Release hub in VSTS and create a new (empty) Release. Select the VisualObjects build as the artifact link and set Continuous Deployment. This will cause the release to be created as soon as a build completes successfully. (If you’re on TFS, you will have to create an empty Release and then link the build in the Artifacts tab). Change the name of the release to something meaningful (I’ve called mine VisualObjects, just to be original).&lt;/p&gt; &lt;p&gt;Change the name of the first environment to “Test”. Edit the variables for the environment and add one called “AdminPassword” and another called “ClusterName”. Set the admin password to some password and padlock it to make it a secret. The name that you choose for the cluster is the DNS name that you’ll use to address your cluster. In my case, I’ve selected “colincluster-test” which will make the URL of my cluster “colincluster-test.eastus.cloudapp.azure.com”.&lt;/p&gt; &lt;p&gt;&lt;a href="http://www.colinsalmcorner.com/posts/files/b581edba-501a-42f1-abb1-910c6d0d292c.png"&gt;&lt;img title="image" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; float: none; padding-top: 0px; padding-left: 0px; margin-left: auto; border-left: 0px; display: block; padding-right: 0px; margin-right: auto" border="0" alt="image" src="http://www.colinsalmcorner.com/posts/files/8419c3bc-7014-4c5e-a82d-082d37e88631.png" width="452" height="146"&gt;&lt;/a&gt;&lt;/p&gt; &lt;h3&gt;Create or Update the Cluster&lt;/h3&gt; &lt;p&gt;If you created the cluster manually, skip to the next task. If you want to create (or update) the cluster as part of the deployment, then add a new “Azure Resource Group Deployment” task to the Test environment. Set the parameters as follows:&lt;/p&gt; &lt;ul&gt; &lt;li&gt;Azure Connection Type: Azure Resource Manager  &lt;li&gt;Azure RM Subscription: set this to the SPN connection you created from &lt;a href="https://blogs.msdn.microsoft.com/visualstudioalm/2015/10/04/automating-azure-resource-group-deployment-using-a-service-principal-in-visual-studio-online-buildrelease-management/" target="_blank"&gt;these instructions&lt;/a&gt;  &lt;li&gt;Action: Create or Update Resource Group  &lt;li&gt;Resource Group: a name for the resource group  &lt;li&gt;Location: the location of your resource group  &lt;li&gt;Template: brows to the TestServiceFabricClusterTemplate.json file in the drop using the browse button (…)  &lt;li&gt;Template Parameters: brows to the TestServiceFabricClusterTemplate.parameters.json file in the drop using the browse button (…)  &lt;li&gt;Override Template Parameters: set this to &lt;font face="Courier New"&gt;-adminPassword (ConvertTo-SecureString '$(AdminPassword)' -AsPlainText -Force) –dnsName $(ClusterName)&lt;/font&gt;&lt;/li&gt;&lt;/ul&gt; &lt;p&gt;You can override any other parameters you need to in the Override parameters setting. For now, I’m just overriding the clusterName and adminPassword parameters.&lt;/p&gt; &lt;p&gt;&lt;a href="http://www.colinsalmcorner.com/posts/files/72527f6b-68ed-4604-935b-54bbccd2c276.png"&gt;&lt;img title="image" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; float: none; padding-top: 0px; padding-left: 0px; margin-left: auto; border-left: 0px; display: block; padding-right: 0px; margin-right: auto" border="0" alt="image" src="http://www.colinsalmcorner.com/posts/files/ce833bce-d00f-44fb-9f68-0fe7269ec8fb.png" width="554" height="222"&gt;&lt;/a&gt;&lt;/p&gt; &lt;h3&gt;Replace Tokens&lt;/h3&gt; &lt;p&gt;The Service Fabric profiles contain the cluster connection information. Since you could be creating the cluster on the fly, I’ve tokenized the connection setting in the profile files as follows:&lt;/p&gt;&lt;pre class="brush: xml; highlight: [20];"&gt;&amp;lt;?xml version="1.0" encoding="utf-8"?&amp;gt;
&amp;lt;PublishProfile xmlns="http://schemas.microsoft.com/2015/05/fabrictools"&amp;gt;
  &amp;lt;!-- ClusterConnectionParameters allows you to specify the PowerShell parameters to use when connecting to the Service Fabric cluster.
       Valid parameters are any that are accepted by the Connect-ServiceFabricCluster cmdlet.
       
       For a remote cluster, you would need to specify the appropriate parameters for that specific cluster.
         For example: &amp;lt;ClusterConnectionParameters ConnectionEndpoint="mycluster.westus.cloudapp.azure.com:19000" /&amp;gt;

       Example showing parameters for a cluster that uses certificate security:
       &amp;lt;ClusterConnectionParameters ConnectionEndpoint="mycluster.westus.cloudapp.azure.com:19000"
                                    X509Credential="true"
                                    ServerCertThumbprint="0123456789012345678901234567890123456789"
                                    FindType="FindByThumbprint"
                                    FindValue="9876543210987654321098765432109876543210"
                                    StoreLocation="CurrentUser"
                                    StoreName="My" /&amp;gt;

  --&amp;gt;
  &amp;lt;!-- Put in the connection to the Prod cluster here --&amp;gt;
  &amp;lt;ClusterConnectionParameters ConnectionEndpoint="__ClusterName__.eastus.cloudapp.azure.com:19000" /&amp;gt;
  &amp;lt;ApplicationParameterFile Path="..\ApplicationParameters\TestCloud.xml" /&amp;gt;
  &amp;lt;UpgradeDeployment Mode="Monitored" Enabled="true"&amp;gt;
    &amp;lt;Parameters FailureAction="Rollback" Force="True" /&amp;gt;
  &amp;lt;/UpgradeDeployment&amp;gt;
&amp;lt;/PublishProfile&amp;gt;
&lt;/pre&gt;
&lt;p&gt;You can see that there is a __ClusterName__ token (the highlighted line). You’ve already defined a value for cluster name that you used in the ARM task. Wouldn’t it be nice if you could simply replace the token called __ClusterName__ with the value of the variable called ClusterName? Since you’ve already installed the &lt;a href="https://marketplace.visualstudio.com/items?itemName=colinsalmcorner.colinsalmcorner-buildtasks" target="_blank"&gt;Colin's ALM Corner Build and Release&lt;/a&gt; extension from the marketplace, you get the &lt;a href="https://github.com/colindembovsky/cols-agent-tasks/tree/master/Tasks/ReplaceTokens" target="_blank"&gt;ReplaceTokens&lt;/a&gt; task as well, which does exactly that! Add a ReplaceTokens task and set it as follows:&lt;/p&gt;
&lt;p&gt;&lt;a href="http://www.colinsalmcorner.com/posts/files/d8d5d37e-6787-4496-8388-1981bdc033d8.png"&gt;&lt;img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; float: none; padding-top: 0px; padding-left: 0px; margin-left: auto; display: block; padding-right: 0px; border-top-width: 0px; margin-right: auto" border="0" alt="image" src="http://www.colinsalmcorner.com/posts/files/b69d8875-9efd-46f8-9f0f-daa427cffec6.png" width="539" height="75"&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;&lt;u&gt;IMPORTANT NOTE!&lt;/u&gt;&lt;/strong&gt; The templates I’ve defined are not secured. In production, you’ll want to secure your clusters. The connection parameters then need a few more tokens like the ServerCertThumbprint and so on. You can also make these tokens that the ReplaceTokens task can substitute. Just note that if you make any of them secrets, you’ll need to specify the secret values in the Advanced section of the task.&lt;/p&gt;
&lt;h3&gt;Deploying the App&lt;/h3&gt;
&lt;p&gt;Now that we have a cluster and we have a profile that can connect to the cluster, and we have a package ready to deploy, we can invoke the PowerShell scrip to deploy! Add a “Powershell Script” task and configure it as follows:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Type: File Path&lt;/li&gt;
&lt;li&gt;Script filename: browse to the Deploy-FabricApplication.ps1 script in the drop folder (under drop/SFPackage/Scripts)&lt;/li&gt;
&lt;li&gt;Arguments: Set to &lt;font face="Courier New"&gt;-PublishProfileFile ../PublishProfiles/TestCloud.xml -ApplicationPackagePath ../Package&lt;/font&gt;&lt;/li&gt;&lt;/ul&gt;
&lt;p&gt;The script needs to take at least the PublishProfile path and then the ApplicationPackage path. These paths are relative to the Scripts folder, so expand Advanced and set the working folder to the Scripts directory:&lt;/p&gt;
&lt;p&gt;&lt;a href="http://www.colinsalmcorner.com/posts/files/7b2458d3-f552-455e-9a56-c3590e7dd56f.png"&gt;&lt;img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; float: none; padding-top: 0px; padding-left: 0px; margin-left: auto; display: block; padding-right: 0px; border-top-width: 0px; margin-right: auto" border="0" alt="image" src="http://www.colinsalmcorner.com/posts/files/fc9e4139-477b-425d-87f0-44383e9b8895.png" width="442" height="128"&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;That’s it! You can now run the release to deploy it to the Test environment. Of course you can add other tasks (like Cloud Load Tests etc.) and approvals. Go wild.&lt;/p&gt;
&lt;h3&gt;Changes to the OOB Deploy Script&lt;/h3&gt;
&lt;p&gt;I mentioned earlier that this technique has a snag: if the release creates the cluster (or you’ve created an empty cluster manually) then the Deploy script will fail. The reason is that the profile includes an &amp;lt;UpgradeDeployment&amp;gt; tag that tells the script to upgrade the app. If the app exists, the script works just fine – but if the app doesn’t exist yet, the deployment will fail. So to work around this, I modified the OOB script slightly. I just query the cluster to see if the app exists, and if it doesn’t, the script calls the Publish-NewServiceFabricApplication cmdlet instead of the Publish-UpgradedServiceFabricApplication. Here are the changed lines:&lt;/p&gt;&lt;pre class="brush: ps; first-line: 185;"&gt;$IsUpgrade = ($publishProfile.UpgradeDeployment -and $publishProfile.UpgradeDeployment.Enabled -and $OverrideUpgradeBehavior -ne 'VetoUpgrade') -or $OverrideUpgradeBehavior -eq 'ForceUpgrade'

# check if this application exists or not
$ManifestFilePath = "$ApplicationPackagePath\ApplicationManifest.xml"
$manifestXml = [Xml] (Get-Content $ManifestFilePath)
$AppTypeName = $manifestXml.ApplicationManifest.ApplicationTypeName
$AppExists = (Get-ServiceFabricApplication | ? { $_.ApplicationTypeName -eq $AppTypeName }) -ne $null

if ($IsUpgrade -and $AppExists)
&lt;/pre&gt;
&lt;p&gt;Lines 1 to 185 of the script are original, (I show line 185 as the first line of this snippet). The if statement alters slightly to take the $AppExists into account – the remainder of the script is as per the OOB script.&lt;/p&gt;
&lt;p&gt;&lt;a href="http://www.colinsalmcorner.com/posts/files/e8408851-eccb-4d52-83b2-172eeeb05876.png"&gt;&lt;img title="image" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; float: none; padding-top: 0px; padding-left: 0px; margin-left: auto; border-left: 0px; display: block; padding-right: 0px; margin-right: auto" border="0" alt="image" src="http://www.colinsalmcorner.com/posts/files/5e86b754-08cc-4227-b460-f17e2b6fe0eb.png" width="754" height="270"&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Now that you have the Test environment, you can clone it to the Prod environment. Change the parameter values (and the template and profile paths) to make the prod-specific and you’re done! One more tip: if you change the release name format (under the general tab) to &lt;font face="Courier New"&gt;$(Build.BuildNumber)-$(rev:r)&lt;/font&gt; then you’ll get the build number as part of the release number.&lt;/p&gt;
&lt;p&gt;Here you can see my cluster with the Application Version matching the build number:&lt;/p&gt;
&lt;p&gt;&lt;a href="http://www.colinsalmcorner.com/posts/files/898c74ec-07c4-41f6-9fb5-cbaddbf83957.png"&gt;&lt;img title="image" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; float: none; padding-top: 0px; padding-left: 0px; margin-left: auto; border-left: 0px; display: block; padding-right: 0px; margin-right: auto" border="0" alt="image" src="http://www.colinsalmcorner.com/posts/files/f51dbe3a-f2c3-4eca-9e5b-f0d548557f88.png" width="634" height="364"&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Sweet! Now I can tell which build was used for my application right from my cluster!&lt;/p&gt;
&lt;h3&gt;See the Pipeline in Action&lt;/h3&gt;
&lt;p&gt;A fun demo to do is to deploy the app and then open up the VisualObjects url – that will be at clustername.eastus.cloudapp.azure.com:8082/VisualObjects (where clustername is the name of your cluster). When you see the bouncing triangles. &lt;/p&gt;
&lt;p&gt;Then you can edit &lt;font face="Courier New"&gt;src/VisualObjects/VisualObjects.ActorService/VisualObjectActor.cs&lt;/font&gt; in Visual Studio or in the Code hub in VSTS. Look around line 50 for &lt;font face="Courier New"&gt;visualObject.Move(false);&lt;/font&gt; and change it to &lt;font face="Courier New"&gt;visualObject.Move(true)&lt;/font&gt;. This will cause the triangle to start rotating. Commit the change and push it to trigger the build and the release. Then monitor the Service Fabric UI to see the upgrade trigger (from the release) and watch the triangles to see how they are upgraded in the Service Fabric rolling upgrade.&lt;/p&gt;
&lt;h2&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;Service Fabric is awesome – and creating a build/release pipeline for Service Fabric apps in VSTS is a snap thanks to an amazing build/release engine – and some cool custom build tasks!&lt;/p&gt;
&lt;p&gt;Happy releasing!&lt;/p&gt;</content>
  <ispublished>true</ispublished>
  <categories>
    <category>DevOps</category>
    <category>Cloud</category>
    <category>teambuild</category>
  </categories>
  <comments>
    <comment isAdmin="false" isApproved="true" id="3a8fb243-6a4f-4383-8d7e-93ef3bf3a08b">
      <author>Antonio</author>
      <email>antonewms@outlook.com</email>
      <website></website>
      <ip>188.152.13.18</ip>
      <userAgent>Mozilla/5.0 (Windows NT 10.0; WOW64; Trident/7.0; rv:11.0) like Gecko</userAgent>
      <date>2016-05-02 14:19:22</date>
      <content>Intereseting, but... I don&amp;#39;t know how to set up a private agent on VSTS. Is it difficult? Is the private agent included in the free VSTS subscription or is it a service to pay? Could you point me to some resources to learn? &lt;br /&gt;I tried to compile a service fabric project with the default hosted agent hoping that maybe they upgraded the agent (this things often change quickly) but the build failed, not on service fabric components (the SF part apparently was compiled , nuget was able to restore relative components) it failed on DNX runtime, I am using ASP.NET core for the frontend part of my project.&lt;br /&gt;IMO the hosted agent should be already compatible with this new strategic MS techonologies like SF and ASP.NET core, I hope they will upgrade soon.&lt;br /&gt;Thanks and sorry for the many questions.</content>
    </comment>
    <comment isAdmin="true" isApproved="true" id="ae2d1485-e78f-43f7-a324-ad028ce5058b">
      <author>Colin Dembovsky</author>
      <email>colindembovsky@gmail.com</email>
      <website>http://colinsalmcorner.com/</website>
      <ip>105.226.114.247</ip>
      <userAgent>Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/50.0.2661.102 Safari/537.36</userAgent>
      <date>2016-05-14 13:17:32</date>
      <content>Hi @Antonio&lt;br /&gt;&lt;br /&gt;You can install a single private agent per account to run as many builds as you want to (no minutes limit). Just go to the build queue admin page and you&amp;#39;ll see a button to download the agent. Install this on your build machine (on prem, Azure - wherever) and run the configuration script to connect to your VSTS instance.&lt;br /&gt;&lt;br /&gt;The VSTS guys are going to be installing the SDK on the hosted image soon - so watch out for that.</content>
    </comment>
    <comment isAdmin="false" isApproved="true" id="4b98ca21-3d60-43a7-9701-f239ad2f5f38">
      <author>@mikanyg</author>
      <email>mikael@mny.dk</email>
      <website></website>
      <ip>2.111.87.245</ip>
      <userAgent>Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/51.0.2704.63 Safari/537.36</userAgent>
      <date>2016-05-25 22:13:18</date>
      <content>Hi&lt;br /&gt;&lt;br /&gt;Great article, most of your instructions I actually did almost the same before reading this blog, good to know that it seemed like a good approch. One thing that I struggled with was the versioning part and upgrades, so your custom build tasks for setting versions will definitely come in handy.&lt;br /&gt;&lt;br /&gt;Your approach is nice an simple, but have you given it any thought for more advanced scenarios where services in an application has different versions? I have some thoughts on this using the gitversion build tasks and diff packages, more info here: https://visualstudio.uservoice.com/forums/330519-team-services/suggestions/13778436-deployment-task-for-service-fabric-applications&lt;br /&gt;&lt;br /&gt;Feel free to tweet if it sounds interesting.</content>
    </comment>
    <comment isAdmin="true" isApproved="true" id="baef225d-e69c-4a6b-9a8b-2df444fff354">
      <author>Colin Dembovsky</author>
      <email>colindembovsky@gmail.com</email>
      <website>http://colinsalmcorner.com/</website>
      <ip>105.228.35.76</ip>
      <userAgent>Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/51.0.2704.103 Safari/537.36</userAgent>
      <date>2016-06-27 06:45:29</date>
      <content>Thanks @mikanyg - yes, there are many different ways of versioning. My solution doesn&amp;#39;t dictate how you come up with the version number at all - so using other versioning schemes is totally doable.</content>
    </comment>
    <comment isAdmin="false" isApproved="true" id="ed90c3f2-3ea3-4803-88be-b4e027fb5000">
      <author>John Kattenhorn</author>
      <email>john.kattenhorn@applicita.com</email>
      <website>http://www.applicita.com/</website>
      <ip>81.149.193.55</ip>
      <userAgent>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/51.0.2704.79 Safari/537.36 Edge/14.14393</userAgent>
      <date>2016-08-31 16:10:02</date>
      <content>Hi Colin,&lt;br /&gt;&lt;br /&gt;I&amp;#39;ve followed you for more years than I care to remember and yet again you get me out of a jam, I was modifying the new Service Fabric VSTS tasks as I didn&amp;#39;t like the way they behaved by writing my own code when I found your solution.&lt;br /&gt;&lt;br /&gt;Much more to my liking, thanks a lot!&lt;br /&gt;&lt;br /&gt;John</content>
    </comment>
    <comment isAdmin="true" isApproved="true" id="d238eac4-92f3-4488-8922-8acd600d442a">
      <author>Colin Dembovsky</author>
      <email>colindembovsky@gmail.com</email>
      <website>http://colinsalmcorner.com/</website>
      <ip>50.204.67.122</ip>
      <userAgent>Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/52.0.2743.116 Safari/537.36</userAgent>
      <date>2016-08-31 17:20:27</date>
      <content>@John - thank you for the positive feedback! Happy to help!</content>
    </comment>
    <comment isAdmin="false" isApproved="true" id="e04e90d9-6715-415c-9678-3679c0dda26c">
      <author>Siva</author>
      <email>sivasankar.swamy@gmail.com</email>
      <website></website>
      <ip>203.99.198.240</ip>
      <userAgent>Mozilla/5.0 (Windows NT 6.3; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/50.0.2661.94 Safari/537.36</userAgent>
      <date>2016-09-28 11:55:08</date>
      <content>hi colin,&lt;br /&gt;&lt;br /&gt;Amazing article... &lt;br /&gt;&lt;br /&gt;Thanks,&lt;br /&gt;Siva.</content>
    </comment>
    <comment isAdmin="false" isApproved="false" id="71cfc3e4-90e8-4f9e-a31f-54f5f595e929">
      <author>John Scott</author>
      <email>getysc@live.com</email>
      <website></website>
      <ip>66.77.129.3</ip>
      <userAgent>Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/61.0.3163.100 Safari/537.36</userAgent>
      <date>2017-10-19 02:10:18</date>
      <content>Hi Colins, I&amp;#39;ve created over 40 release templates in VSTS to deploy 40 services. How to trigger a release for all these templates with one click?&lt;br /&gt;&lt;br /&gt;I&amp;#39;m able to deploy latest build for all these services using VSTS API.&lt;br /&gt;&lt;br /&gt;I didn&amp;#39;t find it easy for later environment as it involved many variables like what release to use for each service.</content>
    </comment>
    <comment isAdmin="false" isApproved="false" id="321228c5-ff68-40da-85a3-8ff5b83442dd">
      <author>Benjamin Goldman</author>
      <email>benjamin.d.goldman@gmail.com</email>
      <website></website>
      <ip>104.129.196.210</ip>
      <userAgent>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/67.0.3396.99 Safari/537.36</userAgent>
      <date>2018-07-18 19:55:29</date>
      <content>When will we get containerized build servers that build containers like the Jenkins people have?</content>
    </comment>
  </comments>
  <viewCount>0</viewCount>
</post>