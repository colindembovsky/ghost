<?xml version="1.0" encoding="utf-8"?>
<post>
  <id>f1538d9f-d573-4cda-9846-e29c4329f8b0</id>
  <title>Testing in Production: Routing Traffic During a Release</title>
  <slug>testing-in-production-routing-traffic-during-a-release</slug>
  <shortUrl>http://bit.ly/2ptzEqN</shortUrl>
  <author></author>
  <pubDate>2017-05-10 00:13:27</pubDate>
  <lastModified>2017-05-10 00:13:27</lastModified>
  <content>&lt;p&gt;DevOps is a journey that every team should at least have started by now. Most of the engagements I have been on in the last year or so have been in the build/release automation space. There are still several practices that I think teams must invest in to remain competitive – unit testing during builds and integration testing during releases are crucial foundations for more advanced DevOps, which I’ve blogged about (a lot) before. However, Application Performance Monitoring (APM) is also something that I believe is becoming more and more critical to successful DevOps teams. And one application of monitoring is &lt;em&gt;hypothesis driven development&lt;/em&gt;.&lt;/p&gt; &lt;h3&gt;Hypothesis Driven Development using App Service Slots&lt;/h3&gt; &lt;p&gt;There are some prerequisites for hypothesis driven development: you need to have metrics that you can measure (I highly, highly recommend using Application Insights to gather the metrics) and you have to have a hypothesis that you can quickly test. Testing in production is the best way to do this – but how do you manage that?&lt;/p&gt; &lt;p&gt;If you’re deploying to Azure App Services, then it’s pretty simple: create a deployment slot on the Web App that you can deploy the “experimental” version of your code to and divert a small percentage of traffic from the real prod site to the experimental slot. Then monitor your metrics. If you’re happy, swap the slots, instantly promoting the experiment. If it does not work, then you’ve failed fast – and you can back out.&lt;/p&gt; &lt;p&gt;Sounds easy. But how do you do all of that in an automated pipeline? Well, you can already deploy to a slot using VSTS and you can already swap slots using OOB tasks. What’s missing is the ability to route a percentage of traffic to a slot.&lt;/p&gt; &lt;h3&gt;Route Traffic Task&lt;/h3&gt; &lt;p&gt;To quote &lt;a href="https://en.wikipedia.org/wiki/Professor_Farnsworth"&gt;Professor Farnsworth&lt;/a&gt;, “Good news everyone!” There is now a &lt;a href="https://github.com/colindembovsky/cols-agent-tasks/tree/master/Tasks/RouteTraffic" target="_blank"&gt;VSTS task&lt;/a&gt; in my &lt;a href="http://bit.ly/cacbuildtasks" target="_blank"&gt;extension pack&lt;/a&gt; that allows you to configure a percentage of traffic to a slot during your release – the Route Traffic task. To use it, just deploy the new version of the site to a slot and then drop in a Route Traffic task to route a percentage of traffic to the staging site. At this point, you can approve or reject the experiment – in both cases, take the traffic percentage down to 0 to the slot (so that 100% traffic goes to the production slot) ad then if the experiment is successful, swap the slots.&lt;/p&gt; &lt;h3&gt;What He Said – In Pictures&lt;/h3&gt; &lt;p&gt;To illustrate that, here’s an example. In this release I have DEV and QA environments (details left out for brevity), and then I’ve split prod into Prod-blue, blue-cleanup and Prod-success. There is a post-approval set on Prod-blue. For both success and failure of the experiment, approve the Prod-blue environment. At this stage, blue-cleanup automatically runs, turning the traffic routing to 0 for the experimental slot. Then Prod-success starts, but it has a pre-approval set that you can approve only if the experiment is successful: it swaps the slots.&lt;/p&gt; &lt;p&gt;Here is the entire release in one graphic:&lt;/p&gt; &lt;p&gt;&lt;a href="http://colinsalmcorner.com/posts/files/f863725e-2677-44d2-801b-b47d56b7c930.png" target="_blank"&gt;&lt;img title="image" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; float: none; padding-top: 0px; padding-left: 0px; margin-left: auto; border-left: 0px; display: block; padding-right: 0px; margin-right: auto" border="0" alt="image" src="http://colinsalmcorner.com/posts/files/269dc0f8-c80b-4a80-8f06-91ca74aeb113.png" width="421" height="258"&gt;&lt;/a&gt;&lt;/p&gt; &lt;p&gt;In Prod-blue, the incoming build is deployed to the “blue” slot on the web app:&lt;/p&gt; &lt;p&gt;&lt;a href="http://colinsalmcorner.com/posts/files/3732c09c-f70e-4358-838d-98553f39e19b.png" target="_blank"&gt;&lt;img title="image" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; float: none; padding-top: 0px; padding-left: 0px; margin-left: auto; border-left: 0px; display: block; padding-right: 0px; margin-right: auto" border="0" alt="image" src="http://colinsalmcorner.com/posts/files/900b2a20-072c-4f73-9e35-2a626ca8a461.png" width="414" height="182"&gt;&lt;/a&gt;&lt;/p&gt; &lt;p&gt;Next, the Route Traffic task routes a percentage of traffic to the blue slot (in this case, 23%):&lt;/p&gt; &lt;p&gt;&lt;a href="http://colinsalmcorner.com/posts/files/1fdf1cdb-3870-4ea4-a74d-5c38a6d69fb6.png" target="_blank"&gt;&lt;img title="image" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; float: none; padding-top: 0px; padding-left: 0px; margin-left: auto; border-left: 0px; display: block; padding-right: 0px; margin-right: auto" border="0" alt="image" src="http://colinsalmcorner.com/posts/files/29c131e0-2413-47ec-944c-4c1844dd96e8.png" width="410" height="166"&gt;&lt;/a&gt;&lt;/p&gt; &lt;p&gt;If you now open the App Service in the Azure Portal, click on “Testing in Production” to view the traffic routing:&lt;/p&gt; &lt;p&gt;&lt;a href="http://colinsalmcorner.com/posts/files/841a61a8-c97c-4be5-948d-876eb20b4d75.png" target="_blank"&gt;&lt;img title="image" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; float: none; padding-top: 0px; padding-left: 0px; margin-left: auto; border-left: 0px; display: block; padding-right: 0px; margin-right: auto" border="0" alt="image" src="http://colinsalmcorner.com/posts/files/bb224c40-b900-4187-b0ec-8c456be61e8b.png" width="419" height="142"&gt;&lt;/a&gt;&lt;/p&gt; &lt;p&gt;Now it’s time to monitor the two slots to check if the experiment is successful. Once you’ve determined the result, you can approve the Prod-blue environment, which automatically triggers the blue-cleanup environment, which updates the traffic routing to route 0% traffic to the blue slot (effectively removing the traffic route altogether).&lt;/p&gt; &lt;p&gt;&lt;a href="http://colinsalmcorner.com/posts/files/de4dbdb2-e9fc-4772-abc3-3d64f629d583.png" target="_blank"&gt;&lt;img title="image" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; float: none; padding-top: 0px; padding-left: 0px; margin-left: auto; border-left: 0px; display: block; padding-right: 0px; margin-right: auto" border="0" alt="image" src="http://colinsalmcorner.com/posts/files/26843d57-249c-4f73-a686-77af531c6027.png" width="436" height="184"&gt;&lt;/a&gt;&lt;/p&gt; &lt;p&gt;Then the Prod-success environment is triggered with a manual pre-deployment configured – reject to end the experiment (if it failed) or approve to execute the swap slot task to make the experimental site production.&lt;/p&gt; &lt;p&gt;&lt;a href="http://colinsalmcorner.com/posts/files/b68db4d3-1553-4a7f-a7b2-a84ac73f5231.png" target="_blank"&gt;&lt;img title="image" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; float: none; padding-top: 0px; padding-left: 0px; margin-left: auto; border-left: 0px; display: block; padding-right: 0px; margin-right: auto" border="0" alt="image" src="http://colinsalmcorner.com/posts/files/d79818cf-6180-44ea-8e95-e1939d4f4655.png" width="435" height="181"&gt;&lt;/a&gt;&lt;/p&gt; &lt;p&gt;Whew! We were able to automate an experiment fairly easily using the Route Traffic task!&lt;/p&gt; &lt;h2&gt;Conclusion&lt;/h2&gt; &lt;p&gt;Using my new Route Traffic task, you can easily configure traffic routing into your pipeline to conduct true A/B testing. Happy hypothesizing!&lt;/p&gt;</content>
  <ispublished>true</ispublished>
  <categories>
    <category>Release Management</category>
    <category>DevOps</category>
  </categories>
  <comments></comments>
  <viewCount>0</viewCount>
</post>