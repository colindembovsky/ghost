{
    "db": [
        {
            "meta": {
                "exported_on": 1586474200049,
                "version": "3.12.1"
            },
            "data": {
                "posts": [
                    {
                        "id": "1",
                        "title": "Custom Build Task: Include Merged Changesets (and Work Items) in Build Report",
                        "slug": "custom-build-task-include-merged-changesets-(and-work-items)-in-build-report",
                        "mobiledoc": "{\"version\":\"0.3.2\",\"atoms\":[],\"cards\":[[\"markdown\",{\"markdown\":\"## Custom Activity\"}],[\"markdown\",{\"markdown\":\"```csharp\\nParameterExpression expression;\\nParameterExpression expression2;\\nParameterExpression expression3;\\n\\nDelegateInArgument<changeset> changeset = new DelegateInArgument<changeset>();\\n\\nForEach<changeset> each = new ForEach<changeset>();\\neach.Values = new InArgument<ienumerable<changeset>>(\\n    Expression.Lambda<func<activitycontext, ienumerable<changeset=\\\"\\\">>>(\\n        Expression.Call(\\n            Expression.Property(\\n                Expression.Constant(this, typeof(AssociateChangesets)), \\n                (MethodInfo) methodof(AssociateChangesets.get_Changesets)), \\n                (MethodInfo) methodof(InArgument<ienumerable<changeset>>.Get, \\n                InArgument<ienumerable<changeset>>\\n            ), \\n            new Expression[] \\n            {\\n                expression = Expression.Parameter(typeof(ActivityContext), \\\"env\\\") \\n            }),\\n            new ParameterExpression[] { expression }\\n        )\\n    );\\n\\nActivityAction<changeset> action = new ActivityAction<changeset>();\\naction.Argument = changeset;\\nSequence sequence = new Sequence();\\nWriteBuildInformation<associatedchangeset> item = new WriteBuildInformation<associatedchangeset>();\\nitem.ParentToBuildDetail = new InArgument<bool>(true);\\nitem.Value = new InArgument<associatedchangeset>(\\n    Expression.Lambda<func<activitycontext, associatedchangeset=\\\"\\\">>(\\n        Expression.MemberInit(\\n            Expression.New((ConstructorInfo) methodof(AssociatedChangeset..ctor), new Expression[0]), \\n            new MemberBinding[] \\n            { \\n                Expression.Bind((MethodInfo) methodof(AssociatedChangeset.set_ChangesetId), \\n                Expression.Property(Expression.Call(Expression.Constant(changeset), \\n                (MethodInfo) methodof(DelegateInArgument<changeset>.Get, DelegateInArgument<changeset>), \\n                new Expression[] { expression2 = Expression.Parameter(typeof(ActivityContext), \\\"env\\\")\\n            }),\\n            (MethodInfo) methodof(Changeset.get_ChangesetId)\\n        )\\n    ),\\n    Expression.Bind((MethodInfo) methodof(AssociatedChangeset.set_ChangesetUri), \\n        Expression.Property(Expression.Call(Expression.Constant(changeset), \\n            (MethodInfo) methodof(DelegateInArgument<changeset>.Get, DelegateInArgument<changeset>), \\n            new Expression[] { expression2 }\\n        ),\\n        (MethodInfo) methodof(Changeset.get_ArtifactUri))\\n    ),\\n    Expression.Bind(\\n        (MethodInfo) methodof(AssociatedChangeset.set_CheckedInBy),\\n        Expression.Property(\\n            Expression.Call(Expression.Constant(changeset), \\n                (MethodInfo) methodof(DelegateInArgument<changeset>.Get, DelegateInArgument<changeset>), \\n                new Expression[] { expression2 }\\n            ),\\n            (MethodInfo) methodof(Changeset.get_OwnerDisplayName)\\n        )\\n    ), \\n    Expression.Bind((MethodInfo) methodof(AssociatedChangeset.set_Comment), \\n        Expression.Property(Expression.Call(\\n            Expression.Constant(changeset),\\n            (MethodInfo) methodof(DelegateInArgument<changeset>.Get, DelegateInArgument<changeset>), \\n            new Expression[] { expression2 }\\n        ), \\n        (MethodInfo) methodof(Changeset.get_Comment))\\n    )\\n    }\\n), \\nnew ParameterExpression[] { expression2 }\\n));\\nsequence.Activities.Add(item);\\nWriteBuildMessage message = new WriteBuildMessage();\\nmessage.Importance = new InArgument<buildmessageimportance>(BuildMessageImportance.Low);\\nmessage.Message = new InArgument<string>(Expression.Lambda<func<activitycontext, string=\\\"\\\">>(\\n    Expression.Call(\\n        null,\\n        (MethodInfo) methodof(ActivitiesResources.Format), \\n        new Expression[] { \\n            Expression.Constant(\\\"BuiltChangeset\\\", typeof(string)),\\n            Expression.NewArrayInit(typeof(object),\\n            new Expression[] { \\n                Expression.Convert(Expression.Property(\\n                    Expression.Call(\\n                        Expression.Constant(changeset),\\n                        (MethodInfo) methodof(DelegateInArgument<changeset>.Get, DelegateInArgument<changeset>\\n                    ), \\n            new Expression[] { \\n                expression3 = Expression.Parameter(typeof(ActivityContext), \\\"env\\\") \\n            }\\n        ),\\n        (MethodInfo) methodof(Changeset.get_ChangesetId)\\n        ), typeof(object))\\n    })\\n    }),\\n     new ParameterExpression[] { expression3 }));\\n\\nsequence.Activities.Add(message);\\naction.Handler = sequence;\\neach.Body = action;\\n\\n```\"}],[\"html\",{\"html\":\"<img title=\\\"image\\\" style=\\\"border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; float: none; padding-top: 0px; padding-left: 0px; margin-left: auto; display: block; padding-right: 0px; border-top-width: 0px; margin-right: auto\\\" border=\\\"0\\\" alt=\\\"image\\\" src=\\\"http://lh3.ggpht.com/-sx4kSEhFBUU/UQ9OPWdKY2I/AAAAAAAAAj8/aKHWN_XfrxU/image_thumb1.png?imgmax=800\\\" width=\\\"228\\\" height=\\\"290\\\">\"}],[\"markdown\",{\"markdown\":\"## 1. Copy your existing Default Workflow\\n\"}],[\"html\",{\"html\":\"<img title=\\\"image\\\" style=\\\"border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; float: none; padding-top: 0px; padding-left: 0px; margin-left: auto; display: block; padding-right: 0px; border-top-width: 0px; margin-right: auto\\\" border=\\\"0\\\" alt=\\\"image\\\" src=\\\"http://lh6.ggpht.com/-MxBjDyShVnM/UQ9ORuMcyKI/AAAAAAAAAkM/BOMW3ptfDQU/image_thumb3.png?imgmax=800\\\" width=\\\"331\\\" height=\\\"114\\\">\"}],[\"html\",{\"html\":\"<img title=\\\"image\\\" style=\\\"border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; float: none; padding-top: 0px; padding-left: 0px; margin-left: auto; display: block; padding-right: 0px; border-top-width: 0px; margin-right: auto\\\" border=\\\"0\\\" alt=\\\"image\\\" src=\\\"http://lh5.ggpht.com/-FX5lcWKZbx4/UQ9OURnksHI/AAAAAAAAAkc/-BCiKi090qc/image_thumb4.png?imgmax=800\\\" width=\\\"241\\\" height=\\\"244\\\">\"}],[\"markdown\",{\"markdown\":\"## 2. Import the Custom Assembly\"}],[\"html\",{\"html\":\"<img title=\\\"image\\\" style=\\\"border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; float: none; padding-top: 0px; padding-left: 0px; margin-left: auto; display: block; padding-right: 0px; border-top-width: 0px; margin-right: auto\\\" border=\\\"0\\\" alt=\\\"image\\\" src=\\\"http://lh4.ggpht.com/-xAM1UQIa-8Y/UQ9OXMWw2GI/AAAAAAAAAks/m6RLn46kRr0/image_thumb6.png?imgmax=800\\\" width=\\\"337\\\" height=\\\"112\\\">\"}],[\"html\",{\"html\":\"<img title=\\\"image\\\" style=\\\"border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; float: none; padding-top: 0px; padding-left: 0px; margin-left: auto; display: block; padding-right: 0px; border-top-width: 0px; margin-right: auto\\\" border=\\\"0\\\" alt=\\\"image\\\" src=\\\"http://lh6.ggpht.com/-uRrVcYJfCvw/UQ9OZhlsYZI/AAAAAAAAAk8/YVIe5GP4b7U/image_thumb7.png?imgmax=800\\\" width=\\\"224\\\" height=\\\"142\\\">\"}],[\"html\",{\"html\":\"<img title=\\\"image\\\" style=\\\"border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; float: none; padding-top: 0px; padding-left: 0px; margin-left: auto; display: block; padding-right: 0px; border-top-width: 0px; margin-right: auto\\\" border=\\\"0\\\" alt=\\\"image\\\" src=\\\"http://lh5.ggpht.com/-PNLPZ-TIG1U/UQ9OcGb9TwI/AAAAAAAAAlI/nHYuiZywnes/image_thumb9.png?imgmax=800\\\" width=\\\"188\\\" height=\\\"272\\\">\"}],[\"markdown\",{\"markdown\":\"## 3. Create a Project for Customizing the Workflow\\n\"}],[\"html\",{\"html\":\"<img title=\\\"image\\\" style=\\\"border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; float: none; padding-top: 0px; padding-left: 0px; margin-left: auto; display: block; padding-right: 0px; border-top-width: 0px; margin-right: auto\\\" border=\\\"0\\\" alt=\\\"image\\\" src=\\\"http://lh4.ggpht.com/-gO5w2ZDWTI8/UQ9OeBOIlhI/AAAAAAAAAlc/H_v1VfWFKYI/image_thumb11.png?imgmax=800\\\" width=\\\"361\\\" height=\\\"175\\\">\"}],[\"html\",{\"html\":\"<img title=\\\"image\\\" style=\\\"border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; float: none; padding-top: 0px; padding-left: 0px; margin-left: auto; display: block; padding-right: 0px; border-top-width: 0px; margin-right: auto\\\" border=\\\"0\\\" alt=\\\"image\\\" src=\\\"http://lh3.ggpht.com/-DHl13JF1PQw/UQ9OhH7_15I/AAAAAAAAAls/GfhW3Pur3XA/image_thumb13.png?imgmax=800\\\" width=\\\"275\\\" height=\\\"223\\\">\"}],[\"markdown\",{\"markdown\":\"* System.Activities\\n* System.Activities.Presentation\\n* PresentationFramework\\n* WindowsBase\\n* System.Xaml\\n* System.Drawing\\n* Microsoft.TeamFoundation.Client\\n* Microsoft.TeamFoundation.Common\\n* Microsoft.TeamFoundation.Build.Client\\n* Microsoft.TeamFoundation.Build.Workflow\\n* Microsoft.TeamFoundation.VersionControl.Client\\n* Microsoft.TeamFoundation.VersionControl.Common\\n* Microsoft.TeamFoundation.WorkItemTracking.Client\"}],[\"markdown\",{\"markdown\":\"* Microsoft.TeamFoundation.TestImpact.BuildIntegration\\n* Microsoft.TeamFoundation.TestImpact.Client\"}],[\"markdown\",{\"markdown\":\"## 4. Adding the Custom Activity\\n\"}],[\"html\",{\"html\":\"<img title=\\\"image\\\" style=\\\"border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; float: none; padding-top: 0px; padding-left: 0px; margin-left: auto; display: block; padding-right: 0px; border-top-width: 0px; margin-right: auto\\\" border=\\\"0\\\" alt=\\\"image\\\" src=\\\"http://lh6.ggpht.com/-6-xAZnOcNoY/UQ9OjQspPoI/AAAAAAAAAl8/gMnIAcik7h4/image_thumb15.png?imgmax=800\\\" width=\\\"314\\\" height=\\\"167\\\">\"}],[\"html\",{\"html\":\"<img title=\\\"image\\\" style=\\\"border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; float: none; padding-top: 0px; padding-left: 0px; margin-left: auto; display: block; padding-right: 0px; border-top-width: 0px; margin-right: auto\\\" border=\\\"0\\\" alt=\\\"image\\\" src=\\\"http://lh3.ggpht.com/-lFWu8OjVd48/UQ9OmArH3xI/AAAAAAAAAmM/4B-7SmXimXU/image_thumb17.png?imgmax=800\\\" width=\\\"263\\\" height=\\\"308\\\">\"}],[\"image\",{\"src\":\"http://lh3.ggpht.com/-p9ttxP6S-JI/UQ9Ope-GqvI/AAAAAAAAAmc/BK2csWUtI3s/image_thumb19.png?imgmax=800\",\"alt\":\"image\",\"title\":\"image\"}],[\"html\",{\"html\":\"<img title=\\\"image\\\" style=\\\"border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; float: none; padding-top: 0px; padding-left: 0px; margin-left: auto; display: block; padding-right: 0px; border-top-width: 0px; margin-right: auto\\\" border=\\\"0\\\" alt=\\\"image\\\" src=\\\"http://lh6.ggpht.com/-E7cwkOw_nDw/UQ9OrySLOFI/AAAAAAAAAms/RRZRlvopbFM/image_thumb21.png?imgmax=800\\\" width=\\\"357\\\" height=\\\"228\\\">\"}],[\"markdown\",{\"markdown\":\"* AssociatedChangesets: set to associatedChangesets (this is the Result of the previous activity)\\n* AssociateMerges: set to IncludeMerges, the Argument you created earlier\\n* Result: set to associatedMergedChangesets, the Variable you created earlier\\n* UpdateWorkItems: set to True\"}],[\"markdown\",{\"markdown\":\"## 5. Merge Back the Workflow\"}],[\"markdown\",{\"markdown\":\"## Create a Build and Run it!\"}],[\"html\",{\"html\":\"<img title=\\\"image\\\" style=\\\"border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; float: none; padding-top: 0px; padding-left: 0px; margin-left: auto; display: block; padding-right: 0px; border-top-width: 0px; margin-right: auto\\\" border=\\\"0\\\" alt=\\\"image\\\" src=\\\"http://lh3.ggpht.com/-5h4mHbRZbZA/UQ9OwDI3ciI/AAAAAAAAAm8/beu4SeFzuSA/image_thumb25.png?imgmax=800\\\" width=\\\"283\\\" height=\\\"423\\\">\"}],[\"markdown\",{\"markdown\":\"## Gotchas to be aware of\"}],[\"markdown\",{\"markdown\":\"## P.S. Attachments\"}]],\"markups\":[[\"strong\"],[\"a\",[\"href\",\"http://tfsbuildextensions.codeplex.com/\"]],[\"a\",[\"href\",\"http://sdrv.ms/VyiAuM\"]]],\"sections\":[[1,\"p\",[[0,[0,0],2,\"Update 2013-07-24\"],[0,[],0,\": This activity is now part of \"],[0,[1],1,\"Community TFS Build Extensions\"],[0,[],0,\".\"]]],[1,\"p\",[[0,[],0,\"I’ve said it before and I’ll say it again – TFS is more than just source control. It’s more than just Work Item Tracking. One of the defining capabilities of TFS is integration across the ALM landscape.\"]]],[1,\"p\",[[0,[],0,\"Currently, if you’re using TeamBuild, you can check code in and build – and the build report will associate the checkins (and their associated work items) with the build. This works great if you don’t have branching… however, if you want to see the changesets that were merged in the build report too, you’re stuck. The information is in TFS – it’s just not easy to surface.\"]]],[1,\"p\",[[0,[],0,\"For example, let’s say you have a DEV-MAIN-LIVE branching hierarchy. Presumably, you’ll work on DEV and do a bunch of checkins. When you do a DEV build, you get a report of all the changes (and work items) that you’ve been working on. So far so good. Now let’s say you have a LIVE build that you merge to once in a while and it’s the LIVE build that you push to the testers. No problem – merge from DEV to MAIN, and then again from MAIN to LIVE. Run the build. Now the tester checks the build report to see what’s “in the build” and they see… nothing. Oh wait, there’s some merge or something – but no work items. What gives?\"]]],[1,\"p\",[[0,[],0,\"The “problem” here is that TeamBuild won’t traverse the merges for the build report. So the only change that’s associated to the LIVE build is the merge from MAIN. Not too helpful.\"]]],[1,\"p\",[[0,[],0,\"But wait: there’s an API that you can use to get the merge sources and so you *could* go and generate your own report. And after years of working with TFS, everyone says you *can* do that in theory, but I haven’t seen anyone actually go and do it.\"]]],[1,\"p\",[[0,[],0,\"The other alternative is to customize the build template to do the heavy lifting for you, so that your LIVE build report shows the merges as well as the merge sources (and their work items).\"]]],[10,0],[1,\"p\",[[0,[],0,\"Unfortunately this is not a trivial customization to make. I had to cuddle up around Reflector and manually “re-code” some Activities from the Microsoft.TeamFoundation.Build.Workflow.Activities namespace (the ones I wanted to use are marked internal – sigh). I’m getting quite good at taking code like this:\"]]],[10,1],[1,\"p\",[[0,[],0,\"and turning it into a Workflow Activity like this:\"]]],[10,2],[1,\"p\",[[0,[],0,\"Anyway, I’ve created an “AssociateMergedChangesetsAndWorkItems” activity that you can plop into your Default workflow that will give you the merged changes too. There’s a little bit of work to get the custom activity in, but it’s nothing you can’t handle!\"]]],[10,3],[1,\"p\",[[0,[],0,\"Of course, by Default here I mean the workflow that you use to compile-and-test-and-associate-changesets-and-workitems. You may have already added some of your own customizations. No problem.\"]]],[1,\"p\",[[0,[],0,\"First, create a copy of your Default workflow (if you want to keep the original around). The easiest way to do this is to create a new build definition, then go to the Process page and expand the “Show Details” section at the top. Click the “New” button:\"]]],[10,4],[1,\"p\",[[0,[],0,\"Now just select the “Copy” option and type a name for the new template. In this case I’m going from the DefaultTemplate11.1.xaml which comes out-the-box in TFS 2012).\"]]],[10,5],[1,\"p\",[[0,[],0,\"Click OK and TFS will create a new XAML for you.\"]]],[1,\"p\",[[0,[],0,\"Open Source Control Explorer and go to your BuildProcessTemplates folder. Make sure you refresh to see the new workflow.\"]]],[10,6],[1,\"p\",[[0,[],0,\"Now check in ColinsALMCorner.CustomBuildTasks.dll (skip right to the bottom of this post for the attachment links) into a folder in Source Control – this folder is where any custom build assembly needs to be located. If you don’t have one, then I suggest you create it under the BuildProcessTemplates folder so that your workflows and custom activities exist together.\"]]],[10,7],[1,\"p\",[[0,[],0,\"Now go to team explorer and go to the Builds pane. Click on the Action dropdown (see below) and select “Manage Build Controllers…”.\"]]],[10,8],[1,\"p\",[[0,[],0,\"Select the Build Controller you want to run the builds through, and click “Properties…”. In the “Version control path to custom assemblies” section, select the folder you just imported the custom dll to. Click OK.\"]]],[10,9],[10,10],[1,\"p\",[[0,[],0,\"(If you’re using the DefaultTemplate and want to skip, you can download this project from the bottom of this post).\"]]],[1,\"p\",[[0,[],0,\"Now comes the painful part: in order to add custom activities in custom assemblies to workflows, you need to make the workflow part of a VS project.\"]]],[1,\"p\",[[0,[],0,\"So – File->New Project and select “Class Library” and give it a suitable name (I chose MergeWorkflow). Make sure you place it in a source controlled folder!\"]]],[1,\"p\",[[0,[],0,\"Delete the “Class1.cs” file (you won’t need it) and add a reference to ColinsALMCorner.CustomBuildTasks.dll (you can even make this reference the local path for the corresponding server path you used for your build controller!). Check this solution into TFS.\"]]],[1,\"p\",[[0,[],0,\"Now go back to Source Control Explorer and branch the Merge workflow that you created in Step 1. You’re going to branch this into your newly imported project folder:\"]]],[10,11],[1,\"p\",[[0,[],0,\"Click OK. Now go back to the solution explorer and click on your project (not the solution, the project). Enable “View All Files” and include the XAML file. Your solution should now look like this:\"]]],[10,12],[1,\"p\",[[0,[],0,\"To get the project compiling, you’ll need to add a bunch of assemblies. These ones are from the GAC:\"]]],[10,13],[1,\"p\",[[0,[],0,\"These ones you’ll have to copy from a TFS server (if you don’t have it installed on your machine). Look in c:\\\\Program Files\\\\Microsoft Team Foundation Server 11.0\\\\Tools as well as in the GAC folders (c:\\\\windows\\\\assembly\\\\GAC_MSIL):\"]]],[10,14],[1,\"p\",[[0,[],0,\"You should now be able to compile the solution. Double click the workflow to open the designer.\"]]],[10,15],[1,\"p\",[[0,[],0,\"Now you can add in the custom activity. In the tabs at the bottom of the workflow designer, click on “Imports”. Then click the dropdown and add ColinsALMCorner.CustomBuildTasks to import it into the workflow.\"]]],[10,16],[1,\"p\",[[0,[],0,\"Click on Arguments and create a new Argument (direction: In, type: Boolean) called “IncludeMerges”. Set the default value to True. You can also specify the MetaData for this argument to expose it in the Build Definition wizard later.\"]]],[10,17],[1,\"p\",[[0,[],0,\"Then click on Variables and add a variable called “associatedMergedChangesets” with Scope “Sequence” and type IList.\"]]],[1,\"p\",[[0,[],0,\"You’ll need to add the custom activity to the Toolbox. To do this, select a section in the toolbox, right click and select “Choose Items”. In the browse dialog, browse to ColinsALMCorner.CustomBuildActivities and click OK. There are a bunch of activities available, but the only one you really need is “AssociateMergedChangesetsAndWorkItems”.\"]]],[10,18],[1,\"p\",[[0,[],0,\"Now scroll down to the If called “If AssociateChangesetsAndWorkItems” (this is the default one in the workflow). Drop an “AssociateMergedChangesetsAndWorkItems” (that’s the new custom activity) into the workflow just below the “AssociateChangesetsAndWorkItems” activity. Set the properties as follows:\"]]],[10,19],[10,20],[1,\"p\",[[0,[],0,\"Make sure the project builds, and check in.\"]]],[10,21],[1,\"p\",[[0,[],0,\"Once you’ve checked in, find the workflow XAML file in your project in Source Control Explorer. Right click, and merge it back to the template in the BuildProcessTemplates folder. Don’t forget to check in the merge!\"]]],[10,22],[1,\"p\",[[0,[],0,\"You’re now ready to run the build. Either create a new build definition or simply change the template of an existing build from the Default template to your newly customized template. Then go checkin, merge and build. Voila!\"]]],[1,\"p\",[[0,[],0,\"So for an example, I have User Story 43, which has a child Task 44. I work on the DEV branch and check in against Task 44 (changeset 97). I then make another DEV change, no work item (changeset 98). I then merge to MAIN (merging changes 97 and 98) in changeset 99. I then merge from MAIN to LIVE in changeset 100.\"]]],[1,\"p\",[[0,[],0,\"Now if you had this scenario and ran the “old” template, you’d get 1 associated changeset (100) and no associated work items. However, running your new flashy “merge-aware” template, you get 4 associated changesets and 2 associated work items (see the build output below). Much better!\"]]],[10,23],[10,24],[1,\"p\",[[0,[],0,\"This does mean that the work items may end up having been associated with 2 (or more) builds. Let’s say you have a DEV build (for CI). In the example above, Task 44 would have its “IntegratedIn” in set to the DEV build. Then you merge DEV to MAIN and MAIN to LIVE, and run the merge workflow on the LIVE branch. The workflow will update the “IntegratedIn” field of Task 44 to the LIVE build. You’ll still see both associations in the History, but the Task’s “IntegratedIn” field is now updated to the latest build (the LIVE build) – which may or may not be what you want. For me, it makes sense this way. Now the build report is a REAL change-log (not just a log of the merge changesets).\"]]],[1,\"p\",[[0,[],0,\"Happy building!\"]]],[10,25],[1,\"p\",[[0,[],0,\"Here’s the link to the \"],[0,[2],1,\"binaries on my skydrive\"],[0,[],0,\". This zip file contains the dll (ColinsALMCorner.CustomBuildTasks) as well as the MergeWorkflow project. You can use this project to get started customizing your workflow. If you’re just using the default workflow without customizations, then you can use the workflow in this project instead of copying it etc. by checking the project into Source Control and then branching the template to the BuildProcessTemplates folder.\"]]]]}",
                        "html": "<p><strong><strong>Update 2013-07-24</strong></strong>: This activity is now part of <a href=\"http://tfsbuildextensions.codeplex.com/\">Community TFS Build Extensions</a>.</p><p>I’ve said it before and I’ll say it again – TFS is more than just source control. It’s more than just Work Item Tracking. One of the defining capabilities of TFS is integration across the ALM landscape.</p><p>Currently, if you’re using TeamBuild, you can check code in and build – and the build report will associate the checkins (and their associated work items) with the build. This works great if you don’t have branching… however, if you want to see the changesets that were merged in the build report too, you’re stuck. The information is in TFS – it’s just not easy to surface.</p><p>For example, let’s say you have a DEV-MAIN-LIVE branching hierarchy. Presumably, you’ll work on DEV and do a bunch of checkins. When you do a DEV build, you get a report of all the changes (and work items) that you’ve been working on. So far so good. Now let’s say you have a LIVE build that you merge to once in a while and it’s the LIVE build that you push to the testers. No problem – merge from DEV to MAIN, and then again from MAIN to LIVE. Run the build. Now the tester checks the build report to see what’s “in the build” and they see… nothing. Oh wait, there’s some merge or something – but no work items. What gives?</p><p>The “problem” here is that TeamBuild won’t traverse the merges for the build report. So the only change that’s associated to the LIVE build is the merge from MAIN. Not too helpful.</p><p>But wait: there’s an API that you can use to get the merge sources and so you *could* go and generate your own report. And after years of working with TFS, everyone says you *can* do that in theory, but I haven’t seen anyone actually go and do it.</p><p>The other alternative is to customize the build template to do the heavy lifting for you, so that your LIVE build report shows the merges as well as the merge sources (and their work items).</p><!--kg-card-begin: markdown--><h2 id=\"customactivity\">Custom Activity</h2>\n<!--kg-card-end: markdown--><p>Unfortunately this is not a trivial customization to make. I had to cuddle up around Reflector and manually “re-code” some Activities from the Microsoft.TeamFoundation.Build.Workflow.Activities namespace (the ones I wanted to use are marked internal – sigh). I’m getting quite good at taking code like this:</p><!--kg-card-begin: markdown--><pre><code class=\"language-csharp\">ParameterExpression expression;\nParameterExpression expression2;\nParameterExpression expression3;\n\nDelegateInArgument&lt;changeset&gt; changeset = new DelegateInArgument&lt;changeset&gt;();\n\nForEach&lt;changeset&gt; each = new ForEach&lt;changeset&gt;();\neach.Values = new InArgument&lt;ienumerable&lt;changeset&gt;&gt;(\n    Expression.Lambda&lt;func&lt;activitycontext, ienumerable&lt;changeset=&quot;&quot;&gt;&gt;&gt;(\n        Expression.Call(\n            Expression.Property(\n                Expression.Constant(this, typeof(AssociateChangesets)), \n                (MethodInfo) methodof(AssociateChangesets.get_Changesets)), \n                (MethodInfo) methodof(InArgument&lt;ienumerable&lt;changeset&gt;&gt;.Get, \n                InArgument&lt;ienumerable&lt;changeset&gt;&gt;\n            ), \n            new Expression[] \n            {\n                expression = Expression.Parameter(typeof(ActivityContext), &quot;env&quot;) \n            }),\n            new ParameterExpression[] { expression }\n        )\n    );\n\nActivityAction&lt;changeset&gt; action = new ActivityAction&lt;changeset&gt;();\naction.Argument = changeset;\nSequence sequence = new Sequence();\nWriteBuildInformation&lt;associatedchangeset&gt; item = new WriteBuildInformation&lt;associatedchangeset&gt;();\nitem.ParentToBuildDetail = new InArgument&lt;bool&gt;(true);\nitem.Value = new InArgument&lt;associatedchangeset&gt;(\n    Expression.Lambda&lt;func&lt;activitycontext, associatedchangeset=&quot;&quot;&gt;&gt;(\n        Expression.MemberInit(\n            Expression.New((ConstructorInfo) methodof(AssociatedChangeset..ctor), new Expression[0]), \n            new MemberBinding[] \n            { \n                Expression.Bind((MethodInfo) methodof(AssociatedChangeset.set_ChangesetId), \n                Expression.Property(Expression.Call(Expression.Constant(changeset), \n                (MethodInfo) methodof(DelegateInArgument&lt;changeset&gt;.Get, DelegateInArgument&lt;changeset&gt;), \n                new Expression[] { expression2 = Expression.Parameter(typeof(ActivityContext), &quot;env&quot;)\n            }),\n            (MethodInfo) methodof(Changeset.get_ChangesetId)\n        )\n    ),\n    Expression.Bind((MethodInfo) methodof(AssociatedChangeset.set_ChangesetUri), \n        Expression.Property(Expression.Call(Expression.Constant(changeset), \n            (MethodInfo) methodof(DelegateInArgument&lt;changeset&gt;.Get, DelegateInArgument&lt;changeset&gt;), \n            new Expression[] { expression2 }\n        ),\n        (MethodInfo) methodof(Changeset.get_ArtifactUri))\n    ),\n    Expression.Bind(\n        (MethodInfo) methodof(AssociatedChangeset.set_CheckedInBy),\n        Expression.Property(\n            Expression.Call(Expression.Constant(changeset), \n                (MethodInfo) methodof(DelegateInArgument&lt;changeset&gt;.Get, DelegateInArgument&lt;changeset&gt;), \n                new Expression[] { expression2 }\n            ),\n            (MethodInfo) methodof(Changeset.get_OwnerDisplayName)\n        )\n    ), \n    Expression.Bind((MethodInfo) methodof(AssociatedChangeset.set_Comment), \n        Expression.Property(Expression.Call(\n            Expression.Constant(changeset),\n            (MethodInfo) methodof(DelegateInArgument&lt;changeset&gt;.Get, DelegateInArgument&lt;changeset&gt;), \n            new Expression[] { expression2 }\n        ), \n        (MethodInfo) methodof(Changeset.get_Comment))\n    )\n    }\n), \nnew ParameterExpression[] { expression2 }\n));\nsequence.Activities.Add(item);\nWriteBuildMessage message = new WriteBuildMessage();\nmessage.Importance = new InArgument&lt;buildmessageimportance&gt;(BuildMessageImportance.Low);\nmessage.Message = new InArgument&lt;string&gt;(Expression.Lambda&lt;func&lt;activitycontext, string=&quot;&quot;&gt;&gt;(\n    Expression.Call(\n        null,\n        (MethodInfo) methodof(ActivitiesResources.Format), \n        new Expression[] { \n            Expression.Constant(&quot;BuiltChangeset&quot;, typeof(string)),\n            Expression.NewArrayInit(typeof(object),\n            new Expression[] { \n                Expression.Convert(Expression.Property(\n                    Expression.Call(\n                        Expression.Constant(changeset),\n                        (MethodInfo) methodof(DelegateInArgument&lt;changeset&gt;.Get, DelegateInArgument&lt;changeset&gt;\n                    ), \n            new Expression[] { \n                expression3 = Expression.Parameter(typeof(ActivityContext), &quot;env&quot;) \n            }\n        ),\n        (MethodInfo) methodof(Changeset.get_ChangesetId)\n        ), typeof(object))\n    })\n    }),\n     new ParameterExpression[] { expression3 }));\n\nsequence.Activities.Add(message);\naction.Handler = sequence;\neach.Body = action;\n\n</code></pre>\n<!--kg-card-end: markdown--><p>and turning it into a Workflow Activity like this:</p><!--kg-card-begin: html--><img title=\"image\" style=\"border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; float: none; padding-top: 0px; padding-left: 0px; margin-left: auto; display: block; padding-right: 0px; border-top-width: 0px; margin-right: auto\" border=\"0\" alt=\"image\" src=\"http://lh3.ggpht.com/-sx4kSEhFBUU/UQ9OPWdKY2I/AAAAAAAAAj8/aKHWN_XfrxU/image_thumb1.png?imgmax=800\" width=\"228\" height=\"290\"><!--kg-card-end: html--><p>Anyway, I’ve created an “AssociateMergedChangesetsAndWorkItems” activity that you can plop into your Default workflow that will give you the merged changes too. There’s a little bit of work to get the custom activity in, but it’s nothing you can’t handle!</p><!--kg-card-begin: markdown--><h2 id=\"1copyyourexistingdefaultworkflow\">1. Copy your existing Default Workflow</h2>\n<!--kg-card-end: markdown--><p>Of course, by Default here I mean the workflow that you use to compile-and-test-and-associate-changesets-and-workitems. You may have already added some of your own customizations. No problem.</p><p>First, create a copy of your Default workflow (if you want to keep the original around). The easiest way to do this is to create a new build definition, then go to the Process page and expand the “Show Details” section at the top. Click the “New” button:</p><!--kg-card-begin: html--><img title=\"image\" style=\"border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; float: none; padding-top: 0px; padding-left: 0px; margin-left: auto; display: block; padding-right: 0px; border-top-width: 0px; margin-right: auto\" border=\"0\" alt=\"image\" src=\"http://lh6.ggpht.com/-MxBjDyShVnM/UQ9ORuMcyKI/AAAAAAAAAkM/BOMW3ptfDQU/image_thumb3.png?imgmax=800\" width=\"331\" height=\"114\"><!--kg-card-end: html--><p>Now just select the “Copy” option and type a name for the new template. In this case I’m going from the DefaultTemplate11.1.xaml which comes out-the-box in TFS 2012).</p><!--kg-card-begin: html--><img title=\"image\" style=\"border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; float: none; padding-top: 0px; padding-left: 0px; margin-left: auto; display: block; padding-right: 0px; border-top-width: 0px; margin-right: auto\" border=\"0\" alt=\"image\" src=\"http://lh5.ggpht.com/-FX5lcWKZbx4/UQ9OURnksHI/AAAAAAAAAkc/-BCiKi090qc/image_thumb4.png?imgmax=800\" width=\"241\" height=\"244\"><!--kg-card-end: html--><p>Click OK and TFS will create a new XAML for you.</p><p>Open Source Control Explorer and go to your BuildProcessTemplates folder. Make sure you refresh to see the new workflow.</p><!--kg-card-begin: markdown--><h2 id=\"2importthecustomassembly\">2. Import the Custom Assembly</h2>\n<!--kg-card-end: markdown--><p>Now check in ColinsALMCorner.CustomBuildTasks.dll (skip right to the bottom of this post for the attachment links) into a folder in Source Control – this folder is where any custom build assembly needs to be located. If you don’t have one, then I suggest you create it under the BuildProcessTemplates folder so that your workflows and custom activities exist together.</p><!--kg-card-begin: html--><img title=\"image\" style=\"border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; float: none; padding-top: 0px; padding-left: 0px; margin-left: auto; display: block; padding-right: 0px; border-top-width: 0px; margin-right: auto\" border=\"0\" alt=\"image\" src=\"http://lh4.ggpht.com/-xAM1UQIa-8Y/UQ9OXMWw2GI/AAAAAAAAAks/m6RLn46kRr0/image_thumb6.png?imgmax=800\" width=\"337\" height=\"112\"><!--kg-card-end: html--><p>Now go to team explorer and go to the Builds pane. Click on the Action dropdown (see below) and select “Manage Build Controllers…”.</p><!--kg-card-begin: html--><img title=\"image\" style=\"border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; float: none; padding-top: 0px; padding-left: 0px; margin-left: auto; display: block; padding-right: 0px; border-top-width: 0px; margin-right: auto\" border=\"0\" alt=\"image\" src=\"http://lh6.ggpht.com/-uRrVcYJfCvw/UQ9OZhlsYZI/AAAAAAAAAk8/YVIe5GP4b7U/image_thumb7.png?imgmax=800\" width=\"224\" height=\"142\"><!--kg-card-end: html--><p>Select the Build Controller you want to run the builds through, and click “Properties…”. In the “Version control path to custom assemblies” section, select the folder you just imported the custom dll to. Click OK.</p><!--kg-card-begin: html--><img title=\"image\" style=\"border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; float: none; padding-top: 0px; padding-left: 0px; margin-left: auto; display: block; padding-right: 0px; border-top-width: 0px; margin-right: auto\" border=\"0\" alt=\"image\" src=\"http://lh5.ggpht.com/-PNLPZ-TIG1U/UQ9OcGb9TwI/AAAAAAAAAlI/nHYuiZywnes/image_thumb9.png?imgmax=800\" width=\"188\" height=\"272\"><!--kg-card-end: html--><!--kg-card-begin: markdown--><h2 id=\"3createaprojectforcustomizingtheworkflow\">3. Create a Project for Customizing the Workflow</h2>\n<!--kg-card-end: markdown--><p>(If you’re using the DefaultTemplate and want to skip, you can download this project from the bottom of this post).</p><p>Now comes the painful part: in order to add custom activities in custom assemblies to workflows, you need to make the workflow part of a VS project.</p><p>So – File-&gt;New Project and select “Class Library” and give it a suitable name (I chose MergeWorkflow). Make sure you place it in a source controlled folder!</p><p>Delete the “Class1.cs” file (you won’t need it) and add a reference to ColinsALMCorner.CustomBuildTasks.dll (you can even make this reference the local path for the corresponding server path you used for your build controller!). Check this solution into TFS.</p><p>Now go back to Source Control Explorer and branch the Merge workflow that you created in Step 1. You’re going to branch this into your newly imported project folder:</p><!--kg-card-begin: html--><img title=\"image\" style=\"border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; float: none; padding-top: 0px; padding-left: 0px; margin-left: auto; display: block; padding-right: 0px; border-top-width: 0px; margin-right: auto\" border=\"0\" alt=\"image\" src=\"http://lh4.ggpht.com/-gO5w2ZDWTI8/UQ9OeBOIlhI/AAAAAAAAAlc/H_v1VfWFKYI/image_thumb11.png?imgmax=800\" width=\"361\" height=\"175\"><!--kg-card-end: html--><p>Click OK. Now go back to the solution explorer and click on your project (not the solution, the project). Enable “View All Files” and include the XAML file. Your solution should now look like this:</p><!--kg-card-begin: html--><img title=\"image\" style=\"border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; float: none; padding-top: 0px; padding-left: 0px; margin-left: auto; display: block; padding-right: 0px; border-top-width: 0px; margin-right: auto\" border=\"0\" alt=\"image\" src=\"http://lh3.ggpht.com/-DHl13JF1PQw/UQ9OhH7_15I/AAAAAAAAAls/GfhW3Pur3XA/image_thumb13.png?imgmax=800\" width=\"275\" height=\"223\"><!--kg-card-end: html--><p>To get the project compiling, you’ll need to add a bunch of assemblies. These ones are from the GAC:</p><!--kg-card-begin: markdown--><ul>\n<li>System.Activities</li>\n<li>System.Activities.Presentation</li>\n<li>PresentationFramework</li>\n<li>WindowsBase</li>\n<li>System.Xaml</li>\n<li>System.Drawing</li>\n<li>Microsoft.TeamFoundation.Client</li>\n<li>Microsoft.TeamFoundation.Common</li>\n<li>Microsoft.TeamFoundation.Build.Client</li>\n<li>Microsoft.TeamFoundation.Build.Workflow</li>\n<li>Microsoft.TeamFoundation.VersionControl.Client</li>\n<li>Microsoft.TeamFoundation.VersionControl.Common</li>\n<li>Microsoft.TeamFoundation.WorkItemTracking.Client</li>\n</ul>\n<!--kg-card-end: markdown--><p>These ones you’ll have to copy from a TFS server (if you don’t have it installed on your machine). Look in c:\\Program Files\\Microsoft Team Foundation Server 11.0\\Tools as well as in the GAC folders (c:\\windows\\assembly\\GAC_MSIL):</p><!--kg-card-begin: markdown--><ul>\n<li>Microsoft.TeamFoundation.TestImpact.BuildIntegration</li>\n<li>Microsoft.TeamFoundation.TestImpact.Client</li>\n</ul>\n<!--kg-card-end: markdown--><p>You should now be able to compile the solution. Double click the workflow to open the designer.</p><!--kg-card-begin: markdown--><h2 id=\"4addingthecustomactivity\">4. Adding the Custom Activity</h2>\n<!--kg-card-end: markdown--><p>Now you can add in the custom activity. In the tabs at the bottom of the workflow designer, click on “Imports”. Then click the dropdown and add ColinsALMCorner.CustomBuildTasks to import it into the workflow.</p><!--kg-card-begin: html--><img title=\"image\" style=\"border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; float: none; padding-top: 0px; padding-left: 0px; margin-left: auto; display: block; padding-right: 0px; border-top-width: 0px; margin-right: auto\" border=\"0\" alt=\"image\" src=\"http://lh6.ggpht.com/-6-xAZnOcNoY/UQ9OjQspPoI/AAAAAAAAAl8/gMnIAcik7h4/image_thumb15.png?imgmax=800\" width=\"314\" height=\"167\"><!--kg-card-end: html--><p>Click on Arguments and create a new Argument (direction: In, type: Boolean) called “IncludeMerges”. Set the default value to True. You can also specify the MetaData for this argument to expose it in the Build Definition wizard later.</p><!--kg-card-begin: html--><img title=\"image\" style=\"border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; float: none; padding-top: 0px; padding-left: 0px; margin-left: auto; display: block; padding-right: 0px; border-top-width: 0px; margin-right: auto\" border=\"0\" alt=\"image\" src=\"http://lh3.ggpht.com/-lFWu8OjVd48/UQ9OmArH3xI/AAAAAAAAAmM/4B-7SmXimXU/image_thumb17.png?imgmax=800\" width=\"263\" height=\"308\"><!--kg-card-end: html--><p>Then click on Variables and add a variable called “associatedMergedChangesets” with Scope “Sequence” and type IList.</p><p>You’ll need to add the custom activity to the Toolbox. To do this, select a section in the toolbox, right click and select “Choose Items”. In the browse dialog, browse to ColinsALMCorner.CustomBuildActivities and click OK. There are a bunch of activities available, but the only one you really need is “AssociateMergedChangesetsAndWorkItems”.</p><figure class=\"kg-card kg-image-card\"><img src=\"http://lh3.ggpht.com/-p9ttxP6S-JI/UQ9Ope-GqvI/AAAAAAAAAmc/BK2csWUtI3s/image_thumb19.png?imgmax=800\" class=\"kg-image\" alt=\"image\" title=\"image\"></figure><p>Now scroll down to the If called “If AssociateChangesetsAndWorkItems” (this is the default one in the workflow). Drop an “AssociateMergedChangesetsAndWorkItems” (that’s the new custom activity) into the workflow just below the “AssociateChangesetsAndWorkItems” activity. Set the properties as follows:</p><!--kg-card-begin: html--><img title=\"image\" style=\"border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; float: none; padding-top: 0px; padding-left: 0px; margin-left: auto; display: block; padding-right: 0px; border-top-width: 0px; margin-right: auto\" border=\"0\" alt=\"image\" src=\"http://lh6.ggpht.com/-E7cwkOw_nDw/UQ9OrySLOFI/AAAAAAAAAms/RRZRlvopbFM/image_thumb21.png?imgmax=800\" width=\"357\" height=\"228\"><!--kg-card-end: html--><!--kg-card-begin: markdown--><ul>\n<li>AssociatedChangesets: set to associatedChangesets (this is the Result of the previous activity)</li>\n<li>AssociateMerges: set to IncludeMerges, the Argument you created earlier</li>\n<li>Result: set to associatedMergedChangesets, the Variable you created earlier</li>\n<li>UpdateWorkItems: set to True</li>\n</ul>\n<!--kg-card-end: markdown--><p>Make sure the project builds, and check in.</p><!--kg-card-begin: markdown--><h2 id=\"5mergebacktheworkflow\">5. Merge Back the Workflow</h2>\n<!--kg-card-end: markdown--><p>Once you’ve checked in, find the workflow XAML file in your project in Source Control Explorer. Right click, and merge it back to the template in the BuildProcessTemplates folder. Don’t forget to check in the merge!</p><!--kg-card-begin: markdown--><h2 id=\"createabuildandrunit\">Create a Build and Run it!</h2>\n<!--kg-card-end: markdown--><p>You’re now ready to run the build. Either create a new build definition or simply change the template of an existing build from the Default template to your newly customized template. Then go checkin, merge and build. Voila!</p><p>So for an example, I have User Story 43, which has a child Task 44. I work on the DEV branch and check in against Task 44 (changeset 97). I then make another DEV change, no work item (changeset 98). I then merge to MAIN (merging changes 97 and 98) in changeset 99. I then merge from MAIN to LIVE in changeset 100.</p><p>Now if you had this scenario and ran the “old” template, you’d get 1 associated changeset (100) and no associated work items. However, running your new flashy “merge-aware” template, you get 4 associated changesets and 2 associated work items (see the build output below). Much better!</p><!--kg-card-begin: html--><img title=\"image\" style=\"border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; float: none; padding-top: 0px; padding-left: 0px; margin-left: auto; display: block; padding-right: 0px; border-top-width: 0px; margin-right: auto\" border=\"0\" alt=\"image\" src=\"http://lh3.ggpht.com/-5h4mHbRZbZA/UQ9OwDI3ciI/AAAAAAAAAm8/beu4SeFzuSA/image_thumb25.png?imgmax=800\" width=\"283\" height=\"423\"><!--kg-card-end: html--><!--kg-card-begin: markdown--><h2 id=\"gotchastobeawareof\">Gotchas to be aware of</h2>\n<!--kg-card-end: markdown--><p>This does mean that the work items may end up having been associated with 2 (or more) builds. Let’s say you have a DEV build (for CI). In the example above, Task 44 would have its “IntegratedIn” in set to the DEV build. Then you merge DEV to MAIN and MAIN to LIVE, and run the merge workflow on the LIVE branch. The workflow will update the “IntegratedIn” field of Task 44 to the LIVE build. You’ll still see both associations in the History, but the Task’s “IntegratedIn” field is now updated to the latest build (the LIVE build) – which may or may not be what you want. For me, it makes sense this way. Now the build report is a REAL change-log (not just a log of the merge changesets).</p><p>Happy building!</p><!--kg-card-begin: markdown--><h2 id=\"psattachments\">P.S. Attachments</h2>\n<!--kg-card-end: markdown--><p>Here’s the link to the <a href=\"http://sdrv.ms/VyiAuM\">binaries on my skydrive</a>. This zip file contains the dll (ColinsALMCorner.CustomBuildTasks) as well as the MergeWorkflow project. You can use this project to get started customizing your workflow. If you’re just using the default workflow without customizations, then you can use the workflow in this project instead of copying it etc. by checking the project into Source Control and then branching the template to the BuildProcessTemplates folder.</p>",
                        "comment_id": "5e8fa6f4ceded40001268738",
                        "plaintext": "Update 2013-07-24: This activity is now part of Community TFS Build Extensions\n[http://tfsbuildextensions.codeplex.com/].\n\nI’ve said it before and I’ll say it again – TFS is more than just source\ncontrol. It’s more than just Work Item Tracking. One of the defining\ncapabilities of TFS is integration across the ALM landscape.\n\nCurrently, if you’re using TeamBuild, you can check code in and build – and the\nbuild report will associate the checkins (and their associated work items) with\nthe build. This works great if you don’t have branching… however, if you want to\nsee the changesets that were merged in the build report too, you’re stuck. The\ninformation is in TFS – it’s just not easy to surface.\n\nFor example, let’s say you have a DEV-MAIN-LIVE branching hierarchy. Presumably,\nyou’ll work on DEV and do a bunch of checkins. When you do a DEV build, you get\na report of all the changes (and work items) that you’ve been working on. So far\nso good. Now let’s say you have a LIVE build that you merge to once in a while\nand it’s the LIVE build that you push to the testers. No problem – merge from\nDEV to MAIN, and then again from MAIN to LIVE. Run the build. Now the tester\nchecks the build report to see what’s “in the build” and they see… nothing. Oh\nwait, there’s some merge or something – but no work items. What gives?\n\nThe “problem” here is that TeamBuild won’t traverse the merges for the build\nreport. So the only change that’s associated to the LIVE build is the merge from\nMAIN. Not too helpful.\n\nBut wait: there’s an API that you can use to get the merge sources and so you\n*could* go and generate your own report. And after years of working with TFS,\neveryone says you *can* do that in theory, but I haven’t seen anyone actually go\nand do it.\n\nThe other alternative is to customize the build template to do the heavy lifting\nfor you, so that your LIVE build report shows the merges as well as the merge\nsources (and their work items).\n\nCustom Activity\nUnfortunately this is not a trivial customization to make. I had to cuddle up\naround Reflector and manually “re-code” some Activities from the\nMicrosoft.TeamFoundation.Build.Workflow.Activities namespace (the ones I wanted\nto use are marked internal – sigh). I’m getting quite good at taking code like\nthis:\n\nParameterExpression expression;\nParameterExpression expression2;\nParameterExpression expression3;\n\nDelegateInArgument<changeset> changeset = new DelegateInArgument<changeset>();\n\nForEach<changeset> each = new ForEach<changeset>();\neach.Values = new InArgument<ienumerable<changeset>>(\n    Expression.Lambda<func<activitycontext, ienumerable<changeset=\"\">>>(\n        Expression.Call(\n            Expression.Property(\n                Expression.Constant(this, typeof(AssociateChangesets)), \n                (MethodInfo) methodof(AssociateChangesets.get_Changesets)), \n                (MethodInfo) methodof(InArgument<ienumerable<changeset>>.Get, \n                InArgument<ienumerable<changeset>>\n            ), \n            new Expression[] \n            {\n                expression = Expression.Parameter(typeof(ActivityContext), \"env\") \n            }),\n            new ParameterExpression[] { expression }\n        )\n    );\n\nActivityAction<changeset> action = new ActivityAction<changeset>();\naction.Argument = changeset;\nSequence sequence = new Sequence();\nWriteBuildInformation<associatedchangeset> item = new WriteBuildInformation<associatedchangeset>();\nitem.ParentToBuildDetail = new InArgument<bool>(true);\nitem.Value = new InArgument<associatedchangeset>(\n    Expression.Lambda<func<activitycontext, associatedchangeset=\"\">>(\n        Expression.MemberInit(\n            Expression.New((ConstructorInfo) methodof(AssociatedChangeset..ctor), new Expression[0]), \n            new MemberBinding[] \n            { \n                Expression.Bind((MethodInfo) methodof(AssociatedChangeset.set_ChangesetId), \n                Expression.Property(Expression.Call(Expression.Constant(changeset), \n                (MethodInfo) methodof(DelegateInArgument<changeset>.Get, DelegateInArgument<changeset>), \n                new Expression[] { expression2 = Expression.Parameter(typeof(ActivityContext), \"env\")\n            }),\n            (MethodInfo) methodof(Changeset.get_ChangesetId)\n        )\n    ),\n    Expression.Bind((MethodInfo) methodof(AssociatedChangeset.set_ChangesetUri), \n        Expression.Property(Expression.Call(Expression.Constant(changeset), \n            (MethodInfo) methodof(DelegateInArgument<changeset>.Get, DelegateInArgument<changeset>), \n            new Expression[] { expression2 }\n        ),\n        (MethodInfo) methodof(Changeset.get_ArtifactUri))\n    ),\n    Expression.Bind(\n        (MethodInfo) methodof(AssociatedChangeset.set_CheckedInBy),\n        Expression.Property(\n            Expression.Call(Expression.Constant(changeset), \n                (MethodInfo) methodof(DelegateInArgument<changeset>.Get, DelegateInArgument<changeset>), \n                new Expression[] { expression2 }\n            ),\n            (MethodInfo) methodof(Changeset.get_OwnerDisplayName)\n        )\n    ), \n    Expression.Bind((MethodInfo) methodof(AssociatedChangeset.set_Comment), \n        Expression.Property(Expression.Call(\n            Expression.Constant(changeset),\n            (MethodInfo) methodof(DelegateInArgument<changeset>.Get, DelegateInArgument<changeset>), \n            new Expression[] { expression2 }\n        ), \n        (MethodInfo) methodof(Changeset.get_Comment))\n    )\n    }\n), \nnew ParameterExpression[] { expression2 }\n));\nsequence.Activities.Add(item);\nWriteBuildMessage message = new WriteBuildMessage();\nmessage.Importance = new InArgument<buildmessageimportance>(BuildMessageImportance.Low);\nmessage.Message = new InArgument<string>(Expression.Lambda<func<activitycontext, string=\"\">>(\n    Expression.Call(\n        null,\n        (MethodInfo) methodof(ActivitiesResources.Format), \n        new Expression[] { \n            Expression.Constant(\"BuiltChangeset\", typeof(string)),\n            Expression.NewArrayInit(typeof(object),\n            new Expression[] { \n                Expression.Convert(Expression.Property(\n                    Expression.Call(\n                        Expression.Constant(changeset),\n                        (MethodInfo) methodof(DelegateInArgument<changeset>.Get, DelegateInArgument<changeset>\n                    ), \n            new Expression[] { \n                expression3 = Expression.Parameter(typeof(ActivityContext), \"env\") \n            }\n        ),\n        (MethodInfo) methodof(Changeset.get_ChangesetId)\n        ), typeof(object))\n    })\n    }),\n     new ParameterExpression[] { expression3 }));\n\nsequence.Activities.Add(message);\naction.Handler = sequence;\neach.Body = action;\n\n\n\nand turning it into a Workflow Activity like this:\n\nAnyway, I’ve created an “AssociateMergedChangesetsAndWorkItems” activity that\nyou can plop into your Default workflow that will give you the merged changes\ntoo. There’s a little bit of work to get the custom activity in, but it’s\nnothing you can’t handle!\n\n1. Copy your existing Default Workflow\nOf course, by Default here I mean the workflow that you use to\ncompile-and-test-and-associate-changesets-and-workitems. You may have already\nadded some of your own customizations. No problem.\n\nFirst, create a copy of your Default workflow (if you want to keep the original\naround). The easiest way to do this is to create a new build definition, then go\nto the Process page and expand the “Show Details” section at the top. Click the\n“New” button:\n\nNow just select the “Copy” option and type a name for the new template. In this\ncase I’m going from the DefaultTemplate11.1.xaml which comes out-the-box in TFS\n2012).\n\nClick OK and TFS will create a new XAML for you.\n\nOpen Source Control Explorer and go to your BuildProcessTemplates folder. Make\nsure you refresh to see the new workflow.\n\n2. Import the Custom Assembly\nNow check in ColinsALMCorner.CustomBuildTasks.dll (skip right to the bottom of\nthis post for the attachment links) into a folder in Source Control – this\nfolder is where any custom build assembly needs to be located. If you don’t have\none, then I suggest you create it under the BuildProcessTemplates folder so that\nyour workflows and custom activities exist together.\n\nNow go to team explorer and go to the Builds pane. Click on the Action dropdown\n(see below) and select “Manage Build Controllers…”.\n\nSelect the Build Controller you want to run the builds through, and click\n“Properties…”. In the “Version control path to custom assemblies” section,\nselect the folder you just imported the custom dll to. Click OK.\n\n3. Create a Project for Customizing the Workflow\n(If you’re using the DefaultTemplate and want to skip, you can download this\nproject from the bottom of this post).\n\nNow comes the painful part: in order to add custom activities in custom\nassemblies to workflows, you need to make the workflow part of a VS project.\n\nSo – File->New Project and select “Class Library” and give it a suitable name (I\nchose MergeWorkflow). Make sure you place it in a source controlled folder!\n\nDelete the “Class1.cs” file (you won’t need it) and add a reference to\nColinsALMCorner.CustomBuildTasks.dll (you can even make this reference the local\npath for the corresponding server path you used for your build controller!).\nCheck this solution into TFS.\n\nNow go back to Source Control Explorer and branch the Merge workflow that you\ncreated in Step 1. You’re going to branch this into your newly imported project\nfolder:\n\nClick OK. Now go back to the solution explorer and click on your project (not\nthe solution, the project). Enable “View All Files” and include the XAML file.\nYour solution should now look like this:\n\nTo get the project compiling, you’ll need to add a bunch of assemblies. These\nones are from the GAC:\n\n * System.Activities\n * System.Activities.Presentation\n * PresentationFramework\n * WindowsBase\n * System.Xaml\n * System.Drawing\n * Microsoft.TeamFoundation.Client\n * Microsoft.TeamFoundation.Common\n * Microsoft.TeamFoundation.Build.Client\n * Microsoft.TeamFoundation.Build.Workflow\n * Microsoft.TeamFoundation.VersionControl.Client\n * Microsoft.TeamFoundation.VersionControl.Common\n * Microsoft.TeamFoundation.WorkItemTracking.Client\n\nThese ones you’ll have to copy from a TFS server (if you don’t have it installed\non your machine). Look in c:\\Program Files\\Microsoft Team Foundation Server\n11.0\\Tools as well as in the GAC folders (c:\\windows\\assembly\\GAC_MSIL):\n\n * Microsoft.TeamFoundation.TestImpact.BuildIntegration\n * Microsoft.TeamFoundation.TestImpact.Client\n\nYou should now be able to compile the solution. Double click the workflow to\nopen the designer.\n\n4. Adding the Custom Activity\nNow you can add in the custom activity. In the tabs at the bottom of the\nworkflow designer, click on “Imports”. Then click the dropdown and add\nColinsALMCorner.CustomBuildTasks to import it into the workflow.\n\nClick on Arguments and create a new Argument (direction: In, type: Boolean)\ncalled “IncludeMerges”. Set the default value to True. You can also specify the\nMetaData for this argument to expose it in the Build Definition wizard later.\n\nThen click on Variables and add a variable called “associatedMergedChangesets”\nwith Scope “Sequence” and type IList.\n\nYou’ll need to add the custom activity to the Toolbox. To do this, select a\nsection in the toolbox, right click and select “Choose Items”. In the browse\ndialog, browse to ColinsALMCorner.CustomBuildActivities and click OK. There are\na bunch of activities available, but the only one you really need is\n“AssociateMergedChangesetsAndWorkItems”.\n\nNow scroll down to the If called “If AssociateChangesetsAndWorkItems” (this is\nthe default one in the workflow). Drop an\n“AssociateMergedChangesetsAndWorkItems” (that’s the new custom activity) into\nthe workflow just below the “AssociateChangesetsAndWorkItems” activity. Set the\nproperties as follows:\n\n * AssociatedChangesets: set to associatedChangesets (this is the Result of the\n   previous activity)\n * AssociateMerges: set to IncludeMerges, the Argument you created earlier\n * Result: set to associatedMergedChangesets, the Variable you created earlier\n * UpdateWorkItems: set to True\n\nMake sure the project builds, and check in.\n\n5. Merge Back the Workflow\nOnce you’ve checked in, find the workflow XAML file in your project in Source\nControl Explorer. Right click, and merge it back to the template in the\nBuildProcessTemplates folder. Don’t forget to check in the merge!\n\nCreate a Build and Run it!\nYou’re now ready to run the build. Either create a new build definition or\nsimply change the template of an existing build from the Default template to\nyour newly customized template. Then go checkin, merge and build. Voila!\n\nSo for an example, I have User Story 43, which has a child Task 44. I work on\nthe DEV branch and check in against Task 44 (changeset 97). I then make another\nDEV change, no work item (changeset 98). I then merge to MAIN (merging changes\n97 and 98) in changeset 99. I then merge from MAIN to LIVE in changeset 100.\n\nNow if you had this scenario and ran the “old” template, you’d get 1 associated\nchangeset (100) and no associated work items. However, running your new flashy\n“merge-aware” template, you get 4 associated changesets and 2 associated work\nitems (see the build output below). Much better!\n\nGotchas to be aware of\nThis does mean that the work items may end up having been associated with 2 (or\nmore) builds. Let’s say you have a DEV build (for CI). In the example above,\nTask 44 would have its “IntegratedIn” in set to the DEV build. Then you merge\nDEV to MAIN and MAIN to LIVE, and run the merge workflow on the LIVE branch. The\nworkflow will update the “IntegratedIn” field of Task 44 to the LIVE build.\nYou’ll still see both associations in the History, but the Task’s “IntegratedIn”\nfield is now updated to the latest build (the LIVE build) – which may or may not\nbe what you want. For me, it makes sense this way. Now the build report is a\nREAL change-log (not just a log of the merge changesets).\n\nHappy building!\n\nP.S. Attachments\nHere’s the link to the binaries on my skydrive [http://sdrv.ms/VyiAuM]. This zip\nfile contains the dll (ColinsALMCorner.CustomBuildTasks) as well as the\nMergeWorkflow project. You can use this project to get started customizing your\nworkflow. If you’re just using the default workflow without customizations, then\nyou can use the workflow in this project instead of copying it etc. by checking\nthe project into Source Control and then branching the template to the\nBuildProcessTemplates folder.",
                        "published_at": 1359964800000,
                        "status": "published"
                    },
                    {
                        "id": "48f3b238-4891-44b2-a906-124629b664cc",
                        "title": "ChatOps with GitHub Actions and Azure Web Apps",
                        "slug": "chatops-with-github-actions-and-azure-web-apps",
                        "mobiledoc": "{\"version\":\"0.3.2\",\"atoms\":[],\"cards\":[[\"html\",{\"html\":\"<iframe width=\\\"560\\\" height=\\\"315\\\" src=\\\"https://www.youtube.com/embed/Yo6O55OQSIA\\\" frameborder=\\\"0\\\" allowfullscreen=\\\"\\\" allow=\\\"accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture\\\"></iframe>\"}]],\"markups\":[[\"a\",[\"href\",\"https://github.com/colindembovsky/azure-webapp-route-traffic\"]],[\"a\",[\"href\",\"https://github.com/colindembovsky/web-app-actions-deploy-sample/\"]]],\"sections\":[[1,\"p\",[[0,[],0,\"Over this weekend, I ported a task from Azure Pipelines to \"],[0,[0],1,\"GitHub Actions\"],[0,[],0,\". It was a fun project, and while I was busy I realized that I could now do some ChatOps. I decided to create a quick video which is below.\"]]],[10,0],[1,\"p\",[[0,[],0,\"Code is in GitHub \"],[0,[1],1,\"here\"],[0,[],0,\".\"]]],[1,\"p\",[[0,[],0,\"Happy chat-opsing!\"]]]]}",
                        "html": "<p>Over this weekend, I ported a task from Azure Pipelines to <a href=\"https://github.com/colindembovsky/azure-webapp-route-traffic\">GitHub Actions</a>. It was a fun project, and while I was busy I realized that I could now do some ChatOps. I decided to create a quick video which is below.</p><!--kg-card-begin: html--><iframe width=\"560\" height=\"315\" src=\"https://www.youtube.com/embed/Yo6O55OQSIA\" frameborder=\"0\" allowfullscreen=\"\" allow=\"accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture\"></iframe><!--kg-card-end: html--><p>Code is in GitHub <a href=\"https://github.com/colindembovsky/web-app-actions-deploy-sample/\">here</a>.</p><p>Happy chat-opsing!</p>",
                        "comment_id": "48f3b238-4891-44b2-a906-124629b664cc",
                        "plaintext": "Over this weekend, I ported a task from Azure Pipelines to GitHub Actions\n[https://github.com/colindembovsky/azure-webapp-route-traffic]. It was a fun\nproject, and while I was busy I realized that I could now do some ChatOps. I\ndecided to create a quick video which is below.\n\nCode is in GitHub here\n[https://github.com/colindembovsky/web-app-actions-deploy-sample/].\n\nHappy chat-opsing!",
                        "published_at": 1585635338000,
                        "status": "published",
                        "published_by": 1
                    }
                ]
            }
        }
    ]
}